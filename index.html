local TransitionEvent = game.ReplicatedStorage:WaitForChild("TransitionEvent")
local TeleportService = game:GetService("TeleportService")
local TeleportID = 137486345319510

local Players = {}
local IsTeleporting = false
local TeleportPoint = script.Parent:WaitForChild("TeleportPoint")
local PlayersAllowed = script.Parent:WaitForChild("PlayersAllowed")
local Gate = script.Parent:WaitForChild("Gate")

local Frame = Gate:WaitForChild("SurfaceGui"):WaitForChild("Frame")
local PlayerNumber = Frame:WaitForChild("PlayerNumber")
local TimeNumber = Frame:WaitForChild("TimeNumber")
local ExitEvent = game.ReplicatedStorage:WaitForChild("ExitEvent")

game.Players.RespawnTime = 0

function Refresh()
	PlayerNumber.Text = tostring(#Players)
end

local function RemoveFromList(Char)
	for i = #Players, 1, -1 do
		if Players[i] == Char.Name then
			table.remove(Players, i)
			if Char:FindFirstChild("Humanoid") then
				Char.Humanoid.JumpPower = 50
			end
			Refresh()
			break
		end
	end
end

local function Teleport()
	if #Players > 0 then
		local TeleportPlayers = {}
		for i = #Players, 1, -1 do
			local plr = game.Players:FindFirstChild(Players[i])
			if plr then
				table.insert(TeleportPlayers, plr)
				TransitionEvent:FireClient(plr)
			else
				table.remove(Players, i)
			end
		end
		if #TeleportPlayers > 0 then
			local Code = TeleportService:ReserveServer(TeleportID)
			IsTeleporting = true
			TeleportService:TeleportToPrivateServer(TeleportID, Code, TeleportPlayers)
			repeat task.wait() until #Players <= 0
			IsTeleporting = false
		end
	end
end

Gate.Touched:Connect(function(Hit)
	if Hit and Hit.Parent:FindFirstChild("Humanoid") then
		local Player = game.Players:GetPlayerFromCharacter(Hit.Parent)
		if not Player then return end
		if not IsTeleporting then
			local Character = Player.Character or Player.CharacterAdded:Wait()
			local AlreadyInside = false
			for _, name in ipairs(Players) do
				if name == Character.Name then
					AlreadyInside = true
					break
				end
			end
			if not AlreadyInside and #Players < PlayersAllowed.Value then
				table.insert(Players, Character.Name)
				local HRP = Character:FindFirstChild("HumanoidRootPart")
				if HRP then
					HRP.CFrame = TeleportPoint.CFrame
				end
				if Character:FindFirstChild("Humanoid") then
					Character.Humanoid.JumpPower = 0
				end
				Refresh()
				ExitEvent:FireClient(Player)
				Player.CharacterRemoving:Once(function(Char)
					RemoveFromList(Char)
				end)
			end
		end
	end
end)

ExitEvent.OnServerEvent:Connect(function(player)
	if player.Character then
		if player.Character:FindFirstChild("Humanoid") then
			player.Character.Humanoid.Health = 0
		end
		RemoveFromList(player.Character)
	end
end)

while true do
	local Timer = 20
	for i = Timer, 1, -1 do
		TimeNumber.Text = tostring(i)
		task.wait(1)
	end
	TimeNumber.Text = "0"
	Teleport()
end