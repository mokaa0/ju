const puppeteer = require('puppeteer');
const fs = require('fs').promises;
const fsSync = require('fs');

class DiscordAccountCreator {
    constructor() {
        this.browser = null;
        this.page = null;
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù…Ù„Ù
    async readFirstLine(filename) {
        try {
            if (!fsSync.existsSync(filename)) {
                console.error(`âŒ Ù…Ù„Ù ${filename} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`);
                return null;
            }
            
            const content = await fs.readFile(filename, 'utf8');
            const lines = content.split('\n').filter(line => line.trim() !== '');
            return lines.length > 0 ? lines[0].trim() : null;
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ${filename}:`, error.message);
            return null;
        }
    }

    // Ø­Ø°Ù Ø£ÙˆÙ„ Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù…Ù„Ù
    async deleteFirstLine(filename) {
        try {
            const content = await fs.readFile(filename, 'utf8');
            const lines = content.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length > 0) {
                const newContent = lines.slice(1).join('\n');
                await fs.writeFile(filename, newContent);
                console.log(`âœ… Ø­Ø°Ù Ø£ÙˆÙ„ Ø³Ø·Ø± Ù…Ù† ${filename}`);
                return true;
            }
            return false;
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ù…Ù† ${filename}:`, error.message);
            return false;
        }
    }

    // ØªÙˆÙ„ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 1990 Ø¥Ù„Ù‰ 2000
    generateDate() {
        const startYear = 1990;
        const endYear = 2000;
        const year = Math.floor(Math.random() * (endYear - startYear + 1)) + startYear;
        const month = Math.floor(Math.random() * 12) + 1;
        const day = Math.floor(Math.random() * 28) + 1;
        
        console.log(`ğŸ² Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙÙˆÙ„Ø¯: ${day}/${month}/${year}`);
        
        return {
            month: month.toString(),
            day: day.toString(),
            year: year.toString()
        };
    }

    // Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    async randomDelay(min = 500, max = 1000) {
        const delay = Math.floor(Math.random() * (max - min + 1)) + min;
        await this.page.waitForTimeout(delay);
    }

    // Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    async fillBirthDate(birthDate) {
        console.log('ğŸ‚ Ø¬Ø§Ø±ÙŠ Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯...');
        
        try {
            // Ø·Ø±ÙŠÙ‚Ø© 1: Ø§Ø³ØªØ®Ø¯Ø§Ù… page.evaluate Ù„Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
            const success = await this.page.evaluate((month, day, year) => {
                try {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
                    const monthSelect = document.querySelector('select[aria-label="Month"], select[name="birthday_month"]');
                    const daySelect = document.querySelector('select[aria-label="Day"], select[name="birthday_day"]');
                    const yearSelect = document.querySelector('select[aria-label="Year"], select[name="birthday_year"]');
                    
                    if (monthSelect && daySelect && yearSelect) {
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…
                        monthSelect.value = month;
                        daySelect.value = day;
                        yearSelect.value = year;
                        
                        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                        ['change', 'input'].forEach(eventType => {
                            [monthSelect, daySelect, yearSelect].forEach(select => {
                                select.dispatchEvent(new Event(eventType, { bubbles: true }));
                            });
                        });
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }, birthDate.month, birthDate.day, birthDate.year);
            
            if (success) {
                console.log(`âœ… ØªÙ… Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${birthDate.day}/${birthDate.month}/${birthDate.year}`);
                await this.randomDelay(1000, 1500);
                return true;
            }
            
            // Ø·Ø±ÙŠÙ‚Ø© 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… page.select Ù…Ø¨Ø§Ø´Ø±Ø©
            console.log('ğŸ”„ Ø¬Ø±Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©...');
            try {
                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±
                await this.page.select('select[aria-label="Month"]', birthDate.month);
                console.log(`âœ… Ø§Ù„Ø´Ù‡Ø±: ${birthDate.month}`);
                await this.randomDelay();
                
                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ…
                await this.page.select('select[aria-label="Day"]', birthDate.day);
                console.log(`âœ… Ø§Ù„ÙŠÙˆÙ…: ${birthDate.day}`);
                await this.randomDelay();
                
                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø©
                await this.page.select('select[aria-label="Year"]', birthDate.year);
                console.log(`âœ… Ø§Ù„Ø³Ù†Ø©: ${birthDate.year}`);
                await this.randomDelay();
                
                console.log(`ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${birthDate.day}/${birthDate.month}/${birthDate.year}`);
                return true;
            } catch (error) {
                console.log('âš ï¸  ÙØ´Ù„Øª Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©');
            }
            
            // Ø·Ø±ÙŠÙ‚Ø© 3: Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©
            console.log('ğŸ”„ Ø¬Ø±Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©...');
            try {
                // Ù…Ù„Ø¡ Ø§Ù„Ø´Ù‡Ø±
                await this.page.click('select[aria-label="Month"]');
                await this.page.keyboard.type(birthDate.month);
                await this.page.keyboard.press('Enter');
                
                // Ù…Ù„Ø¡ Ø§Ù„ÙŠÙˆÙ…
                await this.page.click('select[aria-label="Day"]');
                await this.page.keyboard.type(birthDate.day);
                await this.page.keyboard.press('Enter');
                
                // Ù…Ù„Ø¡ Ø§Ù„Ø³Ù†Ø©
                await this.page.click('select[aria-label="Year"]');
                await this.page.keyboard.type(birthDate.year);
                await this.page.keyboard.press('Enter');
                
                console.log(`âœ… ØªÙ… Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©: ${birthDate.day}/${birthDate.month}/${birthDate.year}`);
                return true;
            } catch (error) {
                console.log('âŒ ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø±Ù‚');
                throw error;
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:', error.message);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            console.log('\nâš ï¸  Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
            console.log('â³ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­');
            console.log(`ğŸ“ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${birthDate.day}/${birthDate.month}/${birthDate.year}`);
            console.log('â±ï¸  Ù„Ø¯ÙŠÙƒ 30 Ø«Ø§Ù†ÙŠØ©...');
            
            // Ø§Ù„ØªÙ‚Ø§Ø· screenshot Ù„ÙØ­Øµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
            await this.page.screenshot({ path: 'date_error.png' });
            
            // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await this.page.waitForTimeout(30000);
            return false;
        }
    }

    // Ù…Ù„Ø¡ Ø­Ù‚Ù„ Display Name
    async fillDisplayName(displayName) {
        console.log('âœï¸  Ù…Ù„Ø¡ Display Name...');
        try {
            await this.page.type('input[name="displayName"]', displayName, { delay: 50 });
            console.log('âœ… ØªÙ… Ù…Ù„Ø¡ Display Name');
        } catch (error) {
            console.log('âš ï¸  Ù„Ù… Ø£Ø¬Ø¯ Ø­Ù‚Ù„ Display Name');
        }
        await this.randomDelay();
    }

    // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Create Account
    async clickCreateAccountButton() {
        console.log('ğŸ–±ï¸  Ù†Ù‚Ø± Ø²Ø± Create Account...');
        try {
            await this.page.click('button[type="submit"]');
            console.log('âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ø±');
            return true;
        } catch (error) {
            console.log('âŒ Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ø²Ø±');
            return false;
        }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    async getDiscordToken() {
        try {
            return await this.page.evaluate(() => {
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    if (value && value.length > 50) {
                        return value;
                    }
                }
                return null;
            });
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†:', error.message);
            return null;
        }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯
    async createSingleAccount() {
        try {
            console.log('\nğŸ“ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const email = await this.readFirstLine('gmails.txt');
            const displayName = await this.readFirstLine('names.txt');
            const username = await this.readFirstLine('username.txt');
            const password = await this.readFirstLine('password.txt');

            if (!email || !displayName || !username || !password) {
                console.error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©!');
                return false;
            }

            console.log(`ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${email}`);
            console.log(`ğŸ‘¤ Display Name: ${displayName}`);
            console.log(`ğŸ”¤ Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ…: ${username}`);
            console.log(`ğŸ” Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: ${password}`);

            // ÙØªØ­ Discord
            console.log('ğŸŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Discord...');
            await this.page.goto('https://discord.com/register', { 
                waitUntil: 'networkidle2',
                timeout: 30000
            });
            
            await this.randomDelay(2000, 3000);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
            const pageUrl = await this.page.url();
            console.log(`ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: ${pageUrl}`);

            // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
            console.log('âœï¸  Ù…Ù„Ø¡ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„...');
            await this.page.type('input[name="email"]', email, { delay: 50 });
            await this.randomDelay();

            await this.fillDisplayName(displayName);

            console.log('âœï¸  Ù…Ù„Ø¡ Username...');
            await this.page.type('input[name="username"]', username, { delay: 50 });
            await this.randomDelay();

            console.log('âœï¸  Ù…Ù„Ø¡ Password...');
            await this.page.type('input[name="password"]', password, { delay: 50 });
            await this.randomDelay(1000, 1500);

            // Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const birthDate = this.generateDate();
            await this.fillBirthDate(birthDate);
            
            // Ø§Ù„ØªÙ‚Ø§Ø· screenshot Ù„Ù„ØªØ£ÙƒØ¯
            await this.page.screenshot({ path: 'form_filled.png' });
            console.log('ğŸ“¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù…Ù„ÙˆØ¡Ø©');

            console.log('\nâœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù…Ù„ÙˆØ¡Ø©!');
            console.log(`ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${birthDate.day}/${birthDate.month}/${birthDate.year}`);

            // Ø§Ù„Ù†Ù‚Ø±
            console.log('\nğŸ¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...');
            const clicked = await this.clickCreateAccountButton();
            
            if (!clicked) {
                console.log('âš ï¸  ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ù‚Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹');
                await this.page.waitForTimeout(10000);
            }

            // Ø§Ù†ØªØ¸Ø§Ø±
            console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± 15 Ø«Ø§Ù†ÙŠØ©...');
            await this.page.waitForTimeout(15000);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
            console.log('ğŸ”‘ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†...');
            const token = await this.getDiscordToken();
            
            if (token) {
                console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†!');
                console.log(`ğŸ” Ø§Ù„ØªÙˆÙƒÙ†: ${token.substring(0, 30)}...`);
                
                // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†
                await fs.appendFile('tokens.txt', `${token}\n`);
                console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†');
                
                // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
                await this.deleteFirstLine('gmails.txt');
                await this.deleteFirstLine('names.txt');
                await this.deleteFirstLine('username.txt');
                await this.deleteFirstLine('password.txt');
                
                console.log('ğŸ—‘ï¸  ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©');
                return token;
            } else {
                console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†');
                
                // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„
                await this.deleteFirstLine('gmails.txt');
                await this.deleteFirstLine('names.txt');
                await this.deleteFirstLine('username.txt');
                await this.deleteFirstLine('password.txt');
                
                return false;
            }

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:', error.message);
            return false;
        }
    }

    async run() {
        console.log(`
==========================================
 Discord Account Creator
==========================================
        `);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
        const requiredFiles = ['gmails.txt', 'names.txt', 'username.txt', 'password.txt'];
        for (const file of requiredFiles) {
            if (!fsSync.existsSync(file)) {
                console.error(`âŒ Ù…Ù„Ù ${file} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`);
                return;
            }
        }

        try {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­...');
            
            this.browser = await puppeteer.launch({ 
                headless: false,
                defaultViewport: null,
                args: ['--start-maximized', '--no-sandbox']
            });
            
            this.page = await this.browser.newPage();
            
            await this.page.setUserAgent(
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            );

            console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­');
            console.log('ğŸ¯ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨...\n');

            const token = await this.createSingleAccount();
            
            if (token) {
                console.log('\nâœ¨ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! âœ¨');
            } else {
                console.log('\nâš ï¸  Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
            }

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error.message);
        } finally {
            console.log('\nâ³ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù...');
            await this.page.waitForTimeout(3000);
            
            if (this.browser) {
                await this.browser.close();
                console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­');
            }
            
            console.log('\nğŸ”„ Ù„Ù„ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬');
        }
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
(async () => {
    const creator = new DiscordAccountCreator();
    await creator.run();
})();