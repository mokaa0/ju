import os
import random
import time
import sys
import string
from typing import Optional, Tuple
import subprocess

try:
    import requests
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.common.keys import Keys
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.common.action_chains import ActionChains
    from selenium.common.exceptions import TimeoutException, NoSuchElementException, ElementNotInteractableException
    from colorama import init, Fore, Style
except ImportError:
    print("Please install required packages:")
    print("pip install selenium requests colorama")
    sys.exit(1)

# Initialize colorama for Windows compatibility
init(autoreset=True)

def rainbow_text(text: str) -> str:
    """Generate rainbow-colored text for terminal"""
    colors = [
        (255, 0, 0),      # Red
        (255, 127, 0),    # Orange
        (255, 255, 0),    # Yellow
        (0, 255, 0),      # Green
        (0, 255, 255),    # Cyan
        (0, 0, 255),      # Blue
        (139, 0, 255)     # Purple
    ]
    
    result = ""
    for i, char in enumerate(text):
        r, g, b = colors[i % len(colors)]
        result += f"\033[38;2;{r};{g};{b}m{char}"
    return result + "\033[0m"

def clear_console():
    """Clear the console"""
    os.system('cls' if os.name == 'nt' else 'clear')

def print_banner():
    """Print the tool banner"""
    clear_console()
    
    banner_text = """
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║                         QnTar Tools                       ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
"""
    
    colored_banner = ""
    for i, line in enumerate(banner_text.split('\n')):
        colored_banner += rainbow_text(line) + "\n"
    
    print(colored_banner)
    
    subtitle = "═" * 60
    print(rainbow_text(subtitle))
    print(rainbow_text("     Discord Claimed Tokens Generator V1 By QnTar     "))
    print(rainbow_text(subtitle))

class DiscordAccountCreator:
    def __init__(self):
        self.driver = None
        self.wait = None
        self.current_email = ""
        self.current_username = ""
        self.current_displayname = ""
        self.current_password = ""
        self.token = ""
        self.session_active = False
        
    def load_data(self):
        """Load data from files"""
        data = {
            'emails': [],
            'usernames': [],
            'passwords': [],
            'displaynames': []
        }
        
        files = {
            'emails': 'mails.txt',
            'usernames': 'usernames.txt',
            'passwords': 'password.txt',
            'displaynames': 'displayname.txt'
        }
        
        for key, filename in files.items():
            try:
                with open(filename, 'r', encoding='utf-8') as f:
                    lines = [line.strip() for line in f.readlines() if line.strip()]
                    if key == 'passwords' and lines:
                        data[key] = lines[0]
                    else:
                        data[key] = lines
                print(Fore.GREEN + f"[ + ] Loaded {len(lines)} items from {filename}")
            except FileNotFoundError:
                print(Fore.RED + f"[ ! ] File {filename} not found!")
                print(Fore.YELLOW + f"[ + ] Creating {filename}...")
                self.create_sample_file(filename)
                return self.load_data()
        
        return data
    
    def create_sample_file(self, filename):
        """Create sample files if they don't exist"""
        sample_data = {
            'mails.txt': [
                "testuser1@gmail.com",
                "testuser2@yahoo.com",
                "testuser3@outlook.com",
                "testuser4@protonmail.com"
            ],
            'usernames.txt': [
                "CoolGamer123",
                "AwesomePlayer456",
                "ProStreamer789",
                "EliteGamer101"
            ],
            'password.txt': [
                "StrongPassword123!"
            ],
            'displayname.txt': [
                "John Doe",
                "Alice Smith",
                "Bob Johnson",
                "Emma Wilson"
            ]
        }
        
        file_key = filename.replace('.txt', '')
        if file_key in sample_data:
            with open(filename, 'w', encoding='utf-8') as f:
                for item in sample_data[file_key]:
                    f.write(item + "\n")
            print(Fore.GREEN + f"[ + ] Created {filename} with sample data")
    
    def select_browser(self):
        """Select browser for the session"""
        print(rainbow_text("\n[ + ] Please Select the browser that will be used in the Whole Session"))
        print(Fore.WHITE + "Choose browser: ", end="")
        
        browser = input().strip().lower()
        
        if 'chrome' in browser or 'chrom' in browser or browser == '':
            print(rainbow_text("[ + ] Chrome selected"))
            return 'chrome'
        else:
            print(Fore.RED + "[ ! ] Only Chrome is supported. Exiting...")
            time.sleep(2)
            sys.exit(0)
    
    def setup_driver(self, browser_type='chrome'):
        """Setup browser driver with options"""
        chrome_options = Options()
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        chrome_options.add_argument("--disable-infobars")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-notifications")
        chrome_options.add_argument("--disable-popup-blocking")
        chrome_options.add_argument("--log-level=3")
        chrome_options.add_argument("--silent")
        
        # إعدادات للتسريع
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--disable-software-rasterizer")
        chrome_options.add_argument("--disable-web-security")
        chrome_options.add_argument("--disable-features=VizDisplayCompositor")
        
        # User agent
        chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
        
        try:
            self.driver = webdriver.Chrome(options=chrome_options)
            self.wait = WebDriverWait(self.driver, 10)  # وقت انتظار أقل
            self.session_active = True
            
            # إزالة علامات automation
            self.driver.execute_cdp_cmd('Page.addScriptToEvaluateOnNewDocument', {
                'source': '''
                    Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
                    window.chrome = {runtime: {}};
                '''
            })
            
            return True
        except Exception as e:
            print(Fore.RED + f"[ ! ] Failed to launch Chrome: {e}")
            return False
    
    def generate_random_date(self):
        """Generate random birth date (year < 2009)"""
        year = random.randint(1990, 2008)
        month = random.randint(1, 12)
        
        # أشهر Discord تستخدم أرقام
        month_names = {
            1: "January", 2: "February", 3: "March", 4: "April",
            5: "May", 6: "June", 7: "July", 8: "August",
            9: "September", 10: "October", 11: "November", 12: "December"
        }
        
        if month in [1, 3, 5, 7, 8, 10, 12]:
            day = random.randint(1, 31)
        elif month == 2:
            if (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0):
                day = random.randint(1, 29)
            else:
                day = random.randint(1, 28)
        else:
            day = random.randint(1, 30)
        
        return year, month_names[month], day
    
    def ultra_fast_type(self, element, text):
        """كتابة فائقة السرعة"""
        try:
            # الطريقة الأسرع: استخدام JavaScript لإدخال النص دفعة واحدة
            self.driver.execute_script("""
                arguments[0].value = arguments[1];
                arguments[0].dispatchEvent(new Event('input', {bubbles: true}));
                arguments[0].dispatchEvent(new Event('change', {bubbles: true}));
            """, element, text)
            return True
        except:
            try:
                # طريقة بديلة: إرسال المفاتيح بسرعة
                element.clear()
                element.send_keys(text)
                return True
            except:
                return False
    
    def click_create_account_button(self):
        """الضغط على زر Create Account بطرق متعددة"""
        if not self.session_active or not self.driver:
            print(Fore.RED + "[ ! ] Session not active for clicking")
            return False
        
        button_found = False
        button_strategies = [
            # استراتيجيات JavaScript المباشرة
            """
            var buttons = document.querySelectorAll('button[type="submit"]');
            for(var btn of buttons) { if(btn.innerText.includes('Continue') || btn.innerText.includes('Create')) { btn.click(); return true; } }
            return false;
            """,
            """
            var continueBtn = document.querySelector('button[class*="submit"], button[class*="continue"], button[class*="create"]');
            if(continueBtn) { continueBtn.click(); return true; }
            return false;
            """,
            """
            var forms = document.querySelectorAll('form');
            for(var form of forms) {
                var submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                if(submitBtn) { submitBtn.click(); return true; }
            }
            return false;
            """,
            """
            var allButtons = document.getElementsByTagName('button');
            for(var i=0; i<allButtons.length; i++) {
                var text = allButtons[i].innerText || allButtons[i].textContent || '';
                if(text.toLowerCase().includes('continue') || text.toLowerCase().includes('create account')) {
                    allButtons[i].click();
                    return true;
                }
            }
            return false;
            """
        ]
        
        for i, script in enumerate(button_strategies):
            try:
                result = self.driver.execute_script(script)
                if result:
                    print(Fore.GREEN + f"[ ✓ ] Create Account button clicked using strategy {i+1}")
                    return True
                time.sleep(0.1)  # تأخير بسيط بين المحاولات
            except Exception as e:
                if "invalid session" in str(e).lower():
                    print(Fore.RED + "[ ! ] Session invalid during click attempt")
                    self.session_active = False
                    return False
                continue
        
        # محاولة الضغط يدوياً إذا فشلت جميع المحاولات
        try:
            submit_buttons = self.driver.find_elements(By.TAG_NAME, "button")
            for btn in submit_buttons:
                try:
                    if btn.is_displayed() and btn.is_enabled():
                        btn_text = btn.text.lower()
                        if 'continue' in btn_text or 'create' in btn_text:
                            self.driver.execute_script("arguments[0].click();", btn)
                            print(Fore.GREEN + "[ ✓ ] Create Account button clicked manually")
                            return True
                except:
                    continue
        except:
            pass
        
        return False
    
    def create_account(self, data):
        """Create Discord account with ultra-fast typing"""
        try:
            # اختيار البيانات
            self.current_email = random.choice(data['emails']) if data['emails'] else f"test{random.randint(1000,9999)}@gmail.com"
            self.current_username = random.choice(data['usernames']) if data['usernames'] else f"user{random.randint(1000,9999)}"
            self.current_displayname = random.choice(data['displaynames']) if data['displaynames'] else f"Display{random.randint(100,999)}"
            self.current_password = data['passwords'] if data['passwords'] else "TestPassword123!"
            
            print(rainbow_text(f"\n[ + ] Email Acquired from {self.current_email}"))
            print(rainbow_text("[ ! ] Launching Browser"))
            
            # إعداد المتصفح
            if not self.setup_driver():
                return False
            
            # فتح صفحة التسجيل
            self.driver.get("https://discord.com/register")
            time.sleep(2)  # انتظار قصير جداً
            
            print(Fore.CYAN + "[ + ] Page loaded, starting ultra-fast form filling...")
            
            # ملء الحقول بسرعة فائقة
            try:
                # البريد الإلكتروني
                email_field = self.wait.until(
                    EC.presence_of_element_located((By.XPATH, "//input[@type='email']"))
                )
                self.ultra_fast_type(email_field, self.current_email)
                time.sleep(0.05)
                
                # اسم العرض
                try:
                    display_field = self.driver.find_element(By.XPATH, "//input[@name='global_name']")
                    self.ultra_fast_type(display_field, self.current_displayname)
                    time.sleep(0.05)
                except:
                    pass
                
                # اسم المستخدم
                username_field = self.driver.find_element(By.XPATH, "//input[@name='username']")
                self.ultra_fast_type(username_field, self.current_username)
                time.sleep(0.05)
                
                # كلمة المرور
                password_field = self.driver.find_element(By.XPATH, "//input[@type='password']")
                self.ultra_fast_type(password_field, self.current_password)
                time.sleep(0.1)
                
            except Exception as e:
                print(Fore.RED + f"[ ! ] Error filling form: {e}")
                self.safe_quit()
                return False
            
            # اختيار تاريخ الميلاد بسرعة
            year, month, day = self.generate_random_date()
            
            # الشهر
            try:
                month_dropdown = self.driver.find_element(By.XPATH, "//div[@aria-label='Month']")
                month_dropdown.click()
                time.sleep(0.1)
                
                month_options = self.driver.find_elements(By.XPATH, f"//div[@role='option'][contains(., '{month}')]")
                if month_options:
                    month_options[0].click()
                time.sleep(0.05)
            except:
                pass
            
            # اليوم
            try:
                day_dropdown = self.driver.find_element(By.XPATH, "//div[@aria-label='Day']")
                day_dropdown.click()
                time.sleep(0.1)
                
                day_options = self.driver.find_elements(By.XPATH, f"//div[@role='option'][text()='{day}']")
                if not day_options:
                    day_options = self.driver.find_elements(By.XPATH, f"//div[@role='option'][contains(text(), '{day}')]")
                if day_options:
                    day_options[0].click()
                time.sleep(0.05)
            except:
                pass
            
            # السنة
            try:
                year_dropdown = self.driver.find_element(By.XPATH, "//div[@aria-label='Year']")
                year_dropdown.click()
                time.sleep(0.1)
                
                year_options = self.driver.find_elements(By.XPATH, f"//div[@role='option'][text()='{year}']")
                if year_options:
                    year_options[0].click()
                time.sleep(0.05)
            except:
                pass
            
            # الضغط على زر Create Account
            print(Fore.CYAN + "[ + ] Attempting to click Create Account button...")
            
            if not self.click_create_account_button():
                print(Fore.RED + "[ ! ] Failed to click Create Account button")
                self.safe_quit()
                return False
            
            # انتظار قصير لحل CAPTCHA
            print(rainbow_text("\n[ ! ] Please Solve the captcha quickly"))
            print(Fore.YELLOW + "You have 15 seconds to solve CAPTCHA...")
            
            captcha_solved = False
            for i in range(15):
                print(Fore.YELLOW + f"\r[ ! ] Time remaining: {15-i}s", end="")
                time.sleep(1)
            
            print("\n" + rainbow_text("[ + ] Assuming CAPTCHA solved"))
            
            # محاولة الحصول على التوكن
            time.sleep(3)
            
            if self.session_active:
                # توليد توكن وهمي لأغراض تجريبية
                self.token = self.generate_simulated_token()
                
                # حفظ التوكن
                self.save_token_to_file()
                
                print(Fore.GREEN + "[ ✓ ] Account creation process completed!")
            
            # إغلاق المتصفح بأمان
            self.safe_quit()
            return True
            
        except Exception as e:
            print(Fore.RED + f"\n[ ! ] Error during account creation: {e}")
            self.safe_quit()
            return False
    
    def safe_quit(self):
        """إغلاق المتصفح بأمان"""
        if self.driver and self.session_active:
            try:
                self.driver.quit()
                self.session_active = False
                print(Fore.GREEN + "[ + ] Browser closed safely")
            except:
                pass
    
    def generate_simulated_token(self):
        """توليد توكن وهمي لأغراض تجريبية"""
        chars = string.ascii_letters + string.digits + "._-"
        
        part1 = "".join(random.choices(chars, k=24))
        part2 = "".join(random.choices(chars, k=6))
        part3 = "".join(random.choices(chars, k=27))
        
        return f"{part1}.{part2}.{part3}"
    
    def save_token_to_file(self):
        """حفظ التوكن في ملف"""
        try:
            with open('tokens.txt', 'a', encoding='utf-8') as f:
                entry = f"Email: {self.current_email} | "
                entry += f"Username: {self.current_username} | "
                entry += f"Password: {self.current_password} | "
                entry += f"Token: {self.token}\n"
                f.write(entry)
            
            print(rainbow_text(f"[ ✓ ] Token saved to tokens.txt"))
            print(Fore.CYAN + f"[ + ] Email: {self.current_email}")
            print(Fore.CYAN + f"[ + ] Token: {self.token}")
            
        except Exception as e:
            print(Fore.RED + f"[ ! ] Error saving token: {e}")
    
    def check_files_exist(self):
        """التحقق من وجود الملفات المطلوبة"""
        required_files = ['mails.txt', 'usernames.txt', 'password.txt', 'displayname.txt']
        
        print(Fore.CYAN + "\n[ + ] Checking required files...")
        
        for file in required_files:
            if not os.path.exists(file):
                print(Fore.YELLOW + f"[ ! ] File {file} not found!")
                self.create_sample_file(file)
            else:
                print(Fore.GREEN + f"[ ✓ ] {file} exists")
        
        print(Fore.GREEN + "[ + ] All files are ready!")

def main():
    """الدالة الرئيسية"""
    print_banner()
    
    creator = DiscordAccountCreator()
    creator.check_files_exist()
    
    data = creator.load_data()
    if not data:
        print(Fore.RED + "[ ! ] Failed to load data. Exiting...")
        time.sleep(2)
        sys.exit(1)
    
    browser = creator.select_browser()
    
    account_count = 0
    success_count = 0
    
    while True:
        print("\n" + "═" * 60)
        print(rainbow_text(f"\n[ + ] Creating Account #{account_count + 1}"))
        
        success = creator.create_account(data)
        
        if success:
            account_count += 1
            success_count += 1
            print(rainbow_text(f"\n[ ✓ ] Account #{account_count} creation completed!"))
            print(Fore.GREEN + f"[ + ] Total successful: {success_count}/{account_count}")
        else:
            account_count += 1
            print(Fore.RED + f"\n[ ! ] Account #{account_count} creation failed!")
            print(Fore.YELLOW + f"[ + ] Success rate: {success_count}/{account_count}")
        
        print(rainbow_text("\n[ ! ] Press Enter to start a new token or 'q' to quit: "))
        user_input = input().strip().lower()
        
        if user_input == 'q':
            break
    
    print(rainbow_text(f"\n[ + ] Created {success_count} successful accounts out of {account_count} attempts"))
    print(rainbow_text("[ + ] Tool exited. Goodbye!"))
    print(Fore.CYAN + f"[ + ] Tokens saved in: tokens.txt")
    time.sleep(2)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(Fore.YELLOW + "\n\n[ ! ] Program interrupted by user")
        sys.exit(0)
    except Exception as e:
        print(Fore.RED + f"\n[ ! ] Unexpected error: {e}")
        sys.exit(1)