const readline = require('readline');
const chalk = require('chalk');
const figlet = require('figlet');
const axios = require('axios');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

// Increased delay to avoid detection
const DELAY = 10000; // 10 seconds between requests

// === Main Menu ===
function showMainMenu() {
    console.clear();
    console.log(chalk.red(figlet.textSync('Original', { font: '3D-ASCII' })));
    console.log(chalk.red('='.repeat(50)));
    console.log(chalk.red.bold('\n[1] HypeSquad For Tokens'));
    console.log(chalk.red.bold('[2] About Me For Tokens'));
    console.log(chalk.red.bold('[3] Add Tokens To Server'));
    console.log(chalk.red.bold('[4] Token Check'));
    console.log(chalk.red('='.repeat(50)));
    
    rl.question(chalk.yellow('\nSelect option (1-4): '), handleChoice);
}

// === Handle Choice ===
async function handleChoice(choice) {
    console.clear();
    switch(choice) {
        case '1': await getHypeSquad(); break;
        case '2': await setAboutMe(); break;
        case '3': await joinServer(); break;
        case '4': await checkTokens(); break;
        default: 
            console.log(chalk.red('Invalid choice'));
            setTimeout(showMainMenu, 2000);
    }
}

// === Option 1: Get HypeSquad Badge ===
async function getHypeSquad() {
    console.log(chalk.cyan('Add Tokens (one per line), type "done" when finished:'));
    
    const tokens = await getTokens();
    let success = 0, failed = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`Checking account ${i+1}/${tokens.length}...`));
            
            // Get user info
            const userResponse = await axios.get('https://discord.com/api/v9/users/@me', {
                headers: { 
                    Authorization: tokens[i],
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            const userTag = `${userResponse.data.username}#${userResponse.data.discriminator}`;
            const flags = userResponse.data.public_flags || 0;
            
            // Check if already has HypeSquad badge
            const hasBravery = (flags & 64) !== 0;
            const hasBrilliance = (flags & 128) !== 0;
            const hasBalance = (flags & 256) !== 0;
            
            if (!hasBravery && !hasBrilliance && !hasBalance) {
                // Get HypeSquad badge
                const houseId = Math.floor(Math.random() * 3) + 1;
                const response = await axios.post('https://discord.com/api/v9/hypesquad/online', 
                    { house_id: houseId },
                    { 
                        headers: { 
                            Authorization: tokens[i],
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    }
                );
                
                if (response.status === 204) {
                    console.log(chalk.green(`${userTag} - HypeSquad badge added (House: ${houseId})`));
                    success++;
                } else {
                    console.log(chalk.red(`${userTag} - Failed with status ${response.status}`));
                    failed++;
                }
            } else {
                console.log(chalk.yellow(`${userTag} - Already has HypeSquad badge`));
                success++; // Count as success since badge exists
            }
        } catch (error) {
            if (error.response?.status === 401) {
                console.log(chalk.red(`Invalid token`));
            } else {
                console.log(chalk.red(`Error: ${error.response?.data?.message || error.message}`));
            }
            failed++;
        }
        
        // Delay to avoid rate limiting
        if (i < tokens.length - 1) await delay(DELAY);
    }
    
    showResults(success, failed);
}

// === Option 2: Set About Me ===
async function setAboutMe() {
    console.log(chalk.cyan('Add Tokens (one per line), type "done" when finished:'));
    
    const tokens = await getTokens();
    const aboutTexts = [
        "Professional gamer and streamer",
        "Software developer exploring new technologies",
        "Book lover and world traveler",
        "Digital artist and creative mind",
        "Science enthusiast and researcher",
        "Full stack developer and tech blogger",
        "University student and part-time freelancer",
        "Photographer and adventure seeker"
    ];
    
    let success = 0, failed = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`Processing account ${i+1}/${tokens.length}...`));
            
            // Set About Me
            const bio = aboutTexts[Math.floor(Math.random() * aboutTexts.length)];
            const response = await axios.patch('https://discord.com/api/v9/users/@me',
                { bio: bio },
                { 
                    headers: { 
                        Authorization: tokens[i],
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                }
            );
            
            console.log(chalk.green(`${response.data.username}#${response.data.discriminator} - About Me updated`));
            success++;
        } catch (error) {
            if (error.response?.status === 401) {
                console.log(chalk.red(`Invalid or expired token`));
            } else if (error.response?.status === 403) {
                console.log(chalk.red(`Account has restrictions or 2FA enabled`));
            } else {
                console.log(chalk.red(`Error: ${error.response?.data?.message || error.message}`));
            }
            failed++;
        }
        
        if (i < tokens.length - 1) await delay(DELAY);
    }
    
    showResults(success, failed);
}

// === Option 3: Join Server ===
async function joinServer() {
    console.log(chalk.cyan('Add Tokens (one per line), type "done" when finished:'));
    const tokens = await getTokens();
    
    if (tokens.length === 0) {
        console.log(chalk.red('No tokens provided'));
        return setTimeout(showMainMenu, 2000);
    }
    
    rl.question(chalk.yellow('Enter server invite link (discord.gg/XXXX): '), async (inviteLink) => {
        const inviteCode = extractInviteCode(inviteLink);
        if (!inviteCode) {
            console.log(chalk.red('Invalid invite link. Format should be discord.gg/CODE'));
            return setTimeout(showMainMenu, 2000);
        }
        
        let success = 0, failed = 0;
        
        for (let i = 0; i < tokens.length; i++) {
            try {
                console.log(chalk.gray(`Account ${i+1}/${tokens.length} joining server...`));
                
                // Join server using invite API
                const response = await axios.post(`https://discord.com/api/v9/invites/${inviteCode}`,
                    {},
                    { 
                        headers: { 
                            Authorization: tokens[i],
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    }
                );
                
                console.log(chalk.green(`Successfully joined server`));
                success++;
            } catch (error) {
                if (error.response?.status === 401) {
                    console.log(chalk.red(`Invalid token`));
                } else if (error.response?.status === 403) {
                    console.log(chalk.red(`Cannot join server - may be banned or require permissions`));
                } else if (error.response?.status === 429) {
                    console.log(chalk.red(`Rate limited - waiting before next attempt`));
                    await delay(DELAY * 2);
                } else {
                    console.log(chalk.red(`Error: ${error.response?.data?.message || error.message}`));
                }
                failed++;
            }
            
            if (i < tokens.length - 1) await delay(DELAY);
        }
        
        showResults(success, failed);
    });
}

// === Option 4: Check Tokens ===
async function checkTokens() {
    console.log(chalk.cyan('Add Tokens (one per line), type "done" when finished:'));
    
    const tokens = await getTokens();
    let valid = 0, invalid = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`Checking token ${i+1}/${tokens.length}...`));
            
            const response = await axios.get('https://discord.com/api/v9/users/@me', {
                headers: { 
                    Authorization: tokens[i],
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            const userTag = `${response.data.username}#${response.data.discriminator}`;
            const emailVerified = response.data.verified ? 'Verified' : 'Not verified';
            
            console.log(chalk.green(`${userTag} - Valid (${emailVerified})`));
            valid++;
        } catch (error) {
            if (error.response?.status === 401) {
                console.log(chalk.red(`Invalid/expired token`));
            } else {
                console.log(chalk.red(`Error: ${error.message}`));
            }
            invalid++;
        }
        
        if (i < tokens.length - 1) await delay(2000);
    }
    
    console.log(chalk.cyan('\n=== Token Check Results ==='));
    console.log(chalk.green(`Valid tokens: ${valid}`));
    console.log(chalk.red(`Invalid tokens: ${invalid}`));
    console.log(chalk.yellow('\nPress Enter to continue...'));
    
    rl.question('', () => {
        showMainMenu();
    });
}

// === Helper Functions ===
async function getTokens() {
    return new Promise((resolve) => {
        const tokens = [];
        
        function askToken() {
            rl.question(chalk.cyan('Enter token: '), (token) => {
                if (token.toLowerCase() === 'done') {
                    if (tokens.length === 0) {
                        console.log(chalk.yellow('No tokens entered.'));
                    }
                    resolve(tokens);
                } else if (token.trim()) {
                    tokens.push(token.trim());
                    askToken();
                } else {
                    askToken();
                }
            });
        }
        
        askToken();
    });
}

function extractInviteCode(link) {
    // Extract code from various invite formats
    const patterns = [
        /discord\.gg\/([a-zA-Z0-9\-_]+)/,
        /discordapp\.com\/invite\/([a-zA-Z0-9\-_]+)/,
        /discord\.com\/invite\/([a-zA-Z0-9\-_]+)/
    ];
    
    for (const pattern of patterns) {
        const match = link.match(pattern);
        if (match && match[1]) {
            return match[1];
        }
    }
    
    // If no pattern matches, assume it's just the code
    return link.trim();
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function showResults(success, failed) {
    console.log(chalk.cyan('\n=== Operation Results ==='));
    console.log(chalk.green(`Successful: ${success}`));
    console.log(chalk.red(`Failed: ${failed}`));
    console.log(chalk.yellow(`\nWarning: Using this tool violates Discord ToS`));
    console.log(chalk.yellow(`Accounts may be banned. Use at your own risk.\n`));
    
    setTimeout(() => {
        console.log(chalk.gray('Returning to main menu in 5 seconds...'));
        setTimeout(showMainMenu, 5000);
    }, 1000);
}

// === Start Program ===
console.log(chalk.red.bold('\n=== WARNING ==='));
console.log(chalk.red.bold('This tool is for educational purposes only'));
console.log(chalk.red.bold('Using user tokens violates Discord Terms of Service'));
console.log(chalk.red.bold('You may lose access to your accounts\n'));

setTimeout(() => {
    showMainMenu();
}, 3000);