const { Client } = require('discord.js-selfbot-v13');
const fs = require('fs').promises;

const EXCLUDED_GUILD_ID = '1441856943265419266'; // السيرفر الي ما تبي تطلع منه

class DiscordLeaveGuilds {
    constructor() {
        this.results = [];
        this.totalGuildsLeft = 0;
    }

    async loadTokens() {
        try {
            const data = await fs.readFile('tokens.txt', 'utf8');
            return data.split('\n')
                .map(token => token.trim())
                .filter(token => token.length > 0);
        } catch (error) {
            console.error('Error reading tokens.txt:', error.message);
            return [];
        }
    }

    async leaveGuildsForToken(token) {
        const client = new Client({
            checkUpdate: false
        });

        return new Promise((resolve, reject) => {
            client.once('ready', async () => {
                try {
                    console.log(`\n══════════════════════════════════════════════════`);
                    console.log(`Processing: ${client.user.tag} (${client.user.id})`);
                    console.log(`══════════════════════════════════════════════════`);
                    
                    const accountResult = {
                        username: client.user.username,
                        discriminator: client.user.discriminator,
                        userId: client.user.id,
                        tokenPreview: token.substring(0, 25) + '...',
                        guildsLeft: [],
                        guildsSkipped: [],
                        failedGuilds: []
                    };

                    const guilds = client.guilds.cache;
                    console.log(`Found ${guilds.size} guilds total`);
                    
                    let processedCount = 0;
                    let leftCount = 0;
                    
                    // جلب معلومات السيرفرات أولاً
                    const guildArray = Array.from(guilds.values());
                    
                    for (const guild of guildArray) {
                        processedCount++;
                        console.log(`\n[${processedCount}/${guilds.size}] Processing guild: ${guild.name} (${guild.id})`);
                        
                        // تخطي السيرفر المستثنى
                        if (guild.id === EXCLUDED_GUILD_ID) {
                            console.log(`   ↪ SKIPPING: This is the excluded guild`);
                            accountResult.guildsSkipped.push({
                                name: guild.name,
                                id: guild.id,
                                memberCount: guild.memberCount
                            });
                            continue;
                        }
                        
                        try {
                            // محاولة الخروج من السيرفر
                            console.log(`   ↪ Attempting to leave guild...`);
                            await guild.leave();
                            
                            console.log(`   ✓ SUCCESS: Left guild "${guild.name}"`);
                            accountResult.guildsLeft.push({
                                name: guild.name,
                                id: guild.id,
                                memberCount: guild.memberCount,
                                success: true
                            });
                            leftCount++;
                            this.totalGuildsLeft++;
                            
                        } catch (leaveError) {
                            console.log(`   ✗ FAILED: Could not leave guild - ${leaveError.message}`);
                            accountResult.failedGuilds.push({
                                name: guild.name,
                                id: guild.id,
                                error: leaveError.message
                            });
                        }
                        
                        // تأخير بين كل سيرفر لتجنب Rate Limit
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                    
                    console.log(`\n══════════════════════════════════════════════════`);
                    console.log(`SUMMARY for ${client.user.tag}:`);
                    console.log(`• Total guilds processed: ${processedCount}`);
                    console.log(`• Guilds left: ${leftCount}`);
                    console.log(`• Guilds skipped: ${accountResult.guildsSkipped.length}`);
                    console.log(`• Failed to leave: ${accountResult.failedGuilds.length}`);
                    console.log(`══════════════════════════════════════════════════\n`);
                    
                    this.results.push(accountResult);
                    resolve(accountResult);
                    
                } catch (error) {
                    reject(error);
                } finally {
                    client.destroy();
                }
            });

            client.on('error', (error) => {
                reject(error);
            });

            client.login(token).catch(reject);
        });
    }

    async displayFinalResults() {
        console.log('\n' + '='.repeat(100));
        console.log('FINAL RESULTS - GUILDS LEFT');
        console.log('='.repeat(100) + '\n');
        
        console.log(`Total accounts processed: ${this.results.length}`);
        console.log(`Total guilds left: ${this.totalGuildsLeft}`);
        console.log(`Excluded guild ID that was not left: ${EXCLUDED_GUILD_ID}\n`);
        
        this.results.forEach((account, index) => {
            console.log(`\n${index + 1}. ${account.username}#${account.discriminator} (${account.userId})`);
            console.log(`   Token: ${account.tokenPreview}`);
            
            if (account.guildsLeft.length > 0) {
                console.log(`   \n   GUILDS LEFT SUCCESSFULLY (${account.guildsLeft.length}):`);
                account.guildsLeft.forEach(guild => {
                    console.log(`   ✓ ${guild.name} (Members: ${guild.memberCount})`);
                });
            }
            
            if (account.guildsSkipped.length > 0) {
                console.log(`   \n   GUILDS SKIPPED (${account.guildsSkipped.length}):`);
                account.guildsSkipped.forEach(guild => {
                    console.log(`   ↪ ${guild.name} (Members: ${guild.memberCount}) - EXCLUDED`);
                });
            }
            
            if (account.failedGuilds.length > 0) {
                console.log(`   \n   GUILDS FAILED TO LEAVE (${account.failedGuilds.length}):`);
                account.failedGuilds.forEach(guild => {
                    console.log(`   ✗ ${guild.name} - Error: ${guild.error}`);
                });
            }
            
            console.log('\n' + '-'.repeat(100));
        });
        
        // حفظ النتائج في ملف
        await this.saveResultsToFile();
    }

    async saveResultsToFile() {
        try {
            // ملف التقرير الكامل
            let fullReport = 'DISCORD GUILDS LEFT REPORT\n';
            fullReport += '='.repeat(50) + '\n\n';
            
            this.results.forEach(account => {
                fullReport += `Account: ${account.username}#${account.discriminator}\n`;
                fullReport += `User ID: ${account.userId}\n`;
                fullReport += `Token: ${account.tokenPreview}\n\n`;
                
                fullReport += `Guilds Left (${account.guildsLeft.length}):\n`;
                account.guildsLeft.forEach(guild => {
                    fullReport += `  ✓ ${guild.name}\n`;
                });
                
                fullReport += `\nGuilds Skipped (${account.guildsSkipped.length}):\n`;
                account.guildsSkipped.forEach(guild => {
                    fullReport += `  ↪ ${guild.name} (EXCLUDED)\n`;
                });
                
                fullReport += `\nGuilds Failed (${account.failedGuilds.length}):\n`;
                account.failedGuilds.forEach(guild => {
                    fullReport += `  ✗ ${guild.name}\n`;
                });
                
                fullReport += '\n' + '='.repeat(50) + '\n\n';
            });
            
            await fs.writeFile('guilds_left_report.txt', fullReport, 'utf8');
            console.log('\nFull report saved to: guilds_left_report.txt');
            
            // ملف التلخيص فقط
            let summary = 'username | guild_name (Left)\n';
            summary += '==========================\n\n';
            
            this.results.forEach(account => {
                account.guildsLeft.forEach(guild => {
                    summary += `${account.username} | ${guild.name}\n`;
                });
            });
            
            await fs.writeFile('left_guilds_summary.txt', summary, 'utf8');
            console.log('Summary saved to: left_guilds_summary.txt');
            
        } catch (error) {
            console.error('Error saving results:', error.message);
        }
    }

    async processAllTokens() {
        const tokens = await this.loadTokens();
        
        if (tokens.length === 0) {
            console.log('No tokens found in tokens.txt');
            return;
        }
        
        console.log(`\n══════════════════════════════════════════════════`);
        console.log(`STARTING GUILD LEAVING PROCESS`);
        console.log(`Found ${tokens.length} token(s) to process`);
        console.log(`Excluding guild ID: ${EXCLUDED_GUILD_ID}`);
        console.log(`══════════════════════════════════════════════════\n`);
        
        for (let i = 0; i < tokens.length; i++) {
            const token = tokens[i];
            
            console.log(`\n╔══════════════════════════════════════════════════╗`);
            console.log(`║ TOKEN ${i + 1}/${tokens.length} - STARTING PROCESS      ║`);
            console.log(`╚══════════════════════════════════════════════════╝\n`);
            
            try {
                await this.leaveGuildsForToken(token);
                console.log(`✓ Completed token ${i + 1}/${tokens.length}`);
                
            } catch (error) {
                console.log(`✗ Failed to process token ${i + 1}: ${error.message}`);
                this.results.push({
                    username: 'FAILED_TOKEN',
                    discriminator: '0000',
                    userId: 'N/A',
                    tokenPreview: token.substring(0, 25) + '...',
                    guildsLeft: [],
                    guildsSkipped: [],
                    failedGuilds: [],
                    error: error.message
                });
            }
            
            // تأخير كبير بين التوكنات لتجنب المشاكل
            if (i < tokens.length - 1) {
                console.log(`\nWaiting 5 seconds before next token...\n`);
                await new Promise(resolve => setTimeout(resolve, 5000));
            }
        }
        
        // عرض النتائج النهائية
        await this.displayFinalResults();
    }
}

// التنفيذ الرئيسي
async function main() {
    const leaver = new DiscordLeaveGuilds();
    
    try {
        await leaver.processAllTokens();
        
        console.log('\n' + '='.repeat(100));
        console.log('PROCESS COMPLETED SUCCESSFULLY!');
        console.log('='.repeat(100));
        
    } catch (error) {
        console.error('Fatal error:', error);
    }
}

// تشغيل السكربت
if (require.main === module) {
    console.log(`
    ██████╗ ██╗███████╗ ██████╗ ██████╗ ██████╗ ██████╗ 
    ██╔══██╗██║██╔════╝██╔════╝██╔═══██╗██╔══██╗██╔══██╗
    ██║  ██║██║███████╗██║     ██║   ██║██████╔╝██║  ██║
    ██║  ██║██║╚════██║██║     ██║   ██║██╔══██╗██║  ██║
    ██████╔╝██║███████║╚██████╗╚██████╔╝██║  ██║██████╔╝
    ╚═════╝ ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ 
    
    Discord Guild Leaver Tool
    Excluding Guild ID: ${EXCLUDED_GUILD_ID}
    `);
    
    main();
}

module.exports = DiscordLeaveGuilds;