require('dotenv').config();
const express = require('express');
const session = require('express-session');
const passport = require('passport');
const DiscordStrategy = require('passport-discord').Strategy;
const MongoClient = require('mongodb').MongoClient;
const path = require('path');
const axios = require('axios');

const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());
app.set('view engine', 'ejs');
app.use(express.static(path.join(__dirname, 'public')));

const scopes = ['identify', 'guilds'];

passport.serializeUser((user, done) => done(null, user));
passport.deserializeUser((obj, done) => done(null, obj));

passport.use(new DiscordStrategy({
    clientID: process.env.CLIENT_ID,
    clientSecret: process.env.CLIENT_SECRET,
    callbackURL: process.env.CALLBACK_URL,
    scope: scopes
}, function(accessToken, refreshToken, profile, done) {
    process.nextTick(() => done(null, profile));
}));

app.use(session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false
}));

app.use(passport.initialize());
app.use(passport.session());

let db;
MongoClient.connect(process.env.MONGO_URI, { useUnifiedTopology: true }, (err, client) => {
    if (err) console.error(err);
    db = client.db('giveawayDB');
});

// Routes
app.get('/', (req, res) => {
    res.render('index', { user: req.user });
});

app.get('/login', passport.authenticate('discord'));

app.get('/callback',
    passport.authenticate('discord', { failureRedirect: '/' }),
    (req, res) => {
        res.redirect('/dashboard');
    }
);

function checkAuth(req, res, next) {
    if (req.isAuthenticated()) return next();
    res.redirect('/');
}

app.get('/dashboard', checkAuth, async (req, res) => {
    // جلب السيرفرات اللي فيها المستخدم حق الادمن
    const guilds = req.user.guilds.filter(g => (g.permissions & 0x8) === 0x8); // ADMINISTRATOR
    const settings = {};
    for (const g of guilds) {
        const guildSettings = await db.collection('servers').findOne({ guildId: g.id }) || {
            prefix: '#',
            giveawayEmoji: 'giveaway001',
            accessRole: null
        };
        settings[g.id] = guildSettings;
    }
    res.render('dashboard', { user: req.user, guilds, settings });
});

app.post('/update/:guildId', checkAuth, async (req, res) => {
    const { prefix, giveawayEmoji, accessRole } = req.body;
    await db.collection('servers').updateOne(
        { guildId: req.params.guildId },
        { $set: { prefix, giveawayEmoji, accessRole } },
        { upsert: true }
    );
    res.redirect('/dashboard');
});

app.get('/logout', (req, res) => {
    req.logout(() => { res.redirect('/'); });
});

app.listen(process.env.PORT, () => console.log(`Dashboard running on port ${process.env.PORT}`));l