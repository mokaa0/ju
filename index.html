import customtkinter as ctk
from tkinter import filedialog
from pymongo import MongoClient
from dotenv import load_dotenv
import os
import requests
import threading
import time

# ================= CONFIG =================
PASSWORD = "teamcore079873393575£!?@&£;:/"

load_dotenv()
MONGO_URI = os.getenv("MONGO_URI")
DB_NAME = os.getenv("DB_NAME")
COLLECTION = os.getenv("COLLECTION")
HOST_URL = os.getenv("HOST_URL")

client = MongoClient(MONGO_URI)
db = client[DB_NAME]
col = db[COLLECTION]

ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("dark-blue")

# ================= APP =================
app = ctk.CTk()
app.geometry("1000x600")
app.title("Host Controller")

# ================= LOG BOX =================
def log(msg, color="white"):
    colors = {
        "green": "#00ff88",
        "red": "#ff5555",
        "yellow": "#ffaa00",
        "white": "#ffffff"
    }
    log_box.configure(state="normal")
    log_box.insert("end", msg + "\n")
    start = log_box.index("end-2l")
    end = log_box.index("end-1l")
    log_box.tag_add(color, start, end)
    log_box.tag_config(color, foreground=colors.get(color, "#ffffff"))
    log_box.configure(state="disabled")
    log_box.see("end")

# ================= LOGIN =================
def login():
    if password_entry.get() == PASSWORD:
        login_frame.pack_forget()
        main_frame.pack(fill="both", expand=True)
        log("Login successful", "green")
    else:
        log("Wrong password", "red")

login_frame = ctk.CTkFrame(app)
login_frame.pack(fill="both", expand=True)

password_entry = ctk.CTkEntry(
    login_frame,
    show="*",
    width=300,
    placeholder_text="Enter Password"
)
password_entry.pack(pady=20)

login_btn = ctk.CTkButton(login_frame, text="Login", command=login)
login_btn.pack()

# ================= MAIN FRAME =================
main_frame = ctk.CTkFrame(app)

# -------- Input File --------
def load_file():
    file = filedialog.askopenfilename(filetypes=[("Text Files", "*.txt")])
    if not file:
        return

    with open(file, "r", encoding="utf-8") as f:
        lines = [line.strip() for line in f if line.strip()]

    for line in lines:
        col.insert_one({"token": line})

    log(f"Saved {len(lines)} tokens to MongoDB", "green")

file_btn = ctk.CTkButton(main_frame, text="Input File", command=load_file)
file_btn.pack(pady=10)

# -------- Host Control --------
running = False

def start_host():
    global running
    try:
        requests.post(f"{HOST_URL}/start", timeout=5)
        running = True
        log("Start command sent", "green")
        threading.Thread(target=listen_logs, daemon=True).start()
    except:
        log("Failed to connect to host", "red")

def stop_host():
    global running
    try:
        requests.post(f"{HOST_URL}/stop", timeout=5)
        running = False
        log("Stop command sent", "red")
    except:
        log("Failed to connect to host", "red")

def restart_host():
    try:
        requests.post(f"{HOST_URL}/restart", timeout=5)
        log("Restart command sent", "yellow")
    except:
        log("Failed to connect to host", "red")

btn_frame = ctk.CTkFrame(main_frame)
btn_frame.pack(pady=10)

ctk.CTkButton(btn_frame, text="Start", fg_color="green", command=start_host)\
    .pack(side="left", padx=10)

ctk.CTkButton(btn_frame, text="Restart", fg_color="orange", command=restart_host)\
    .pack(side="left", padx=10)

ctk.CTkButton(btn_frame, text="Stop", fg_color="red", command=stop_host)\
    .pack(side="left", padx=10)

# -------- Log View --------
log_box = ctk.CTkTextbox(main_frame, height=350)
log_box.pack(fill="both", expand=True, padx=10, pady=10)
log_box.configure(state="disabled")

# ================= HOST LOG LISTENER =================
def listen_logs():
    while running:
        try:
            r = requests.get(f"{HOST_URL}/logs", timeout=5)
            if r.status_code == 200:
                logs = r.json()
                for item in logs:
                    log(item.get("msg", ""), item.get("color", "white"))
        except:
            pass
        time.sleep(1)

app.mainloop()