const figlet = require('figlet');
const chalk = require('chalk');
const fs = require('fs');
const fetch = require('node-fetch');

console.log(chalk.cyan(figlet.textSync('Qya', { horizontalLayout: 'default' })));
console.log(chalk.blue('\nQya Studio - username tokens tool'));
console.log(chalk.yellow('Developed by .884.'));
console.log(chalk.yellow('Random username'));
console.log(chalk.green('Loading Tool…'));

const usernamesPath = './username.txt';
const tokensPath = './tokens.txt';

let usernames = [];
let tokens = [];

try {
  usernames = fs.readFileSync(usernamesPath, 'utf-8').split('\n').filter(Boolean);
  console.log(chalk.green(`Loaded ${usernames.length} username`));
} catch (err) {
  console.log(chalk.red('Error loading usernames:', err.message));
  process.exit();
}

try {
  tokens = fs.readFileSync(tokensPath, 'utf-8').split('\n').filter(Boolean);
  console.log(chalk.green(`Loaded ${tokens.length} tokens`));
} catch (err) {
  console.log(chalk.red('Error loading tokens:', err.message));
  process.exit();
}

console.log(chalk.yellow('Connecting valid accounts…'));


let valid = 0;
let invalid = 0;

async function changeUsername(token, newUsername) {
  try {
    const res = await fetch('https://discord.com/api/v9/users/@me', {
      method: 'PATCH',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ username: newUsername }),
    });

    if (res.status === 200) {
      console.log(chalk.blue(`${token.slice(0, 15)}... - ${newUsername}`));
      return true;
    } else {
      const json = await res.json();
      if (json.message === "Unauthorized" || json.code === 0) {
        return false;
      }
    }
  } catch (e) {
    return false;
  }

  return false;
}

(async () => {
  for (const token of tokens) {
    if (usernames.length === 0) {
      console.log(chalk.red('No more usernames available!'));
      break;
    }

    const username = usernames.shift();

    const success = await changeUsername(token, username);

    if (success) {
      valid++;
      fs.writeFileSync(usernamesPath, usernames.join('\n')); // remove used
    } else {
      invalid++;
    }

    await new Promise(r => setTimeout(r, 4000));
  }

  console.log(chalk.green('\nAll accounts initialized.\n'));
  console.log(chalk.green('Status'));
  console.log(chalk.green(` - Valid tokens total : ${valid}`));
  console.log(chalk.green(` - Invalid tokens : ${invalid}`));
})();