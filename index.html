// commands/logs.js
const fs = require('fs');
const path = require('path');
const { EmbedBuilder, PermissionsBitField } = require('discord.js');
const { getGuildSettings } = require('../utils/settings');

module.exports = {
  name: 'logs',
  description: 'Enable/disable logging for a specific category',
  async execute(message, args) {
    if (!message.guild) return;

    const settings = getGuildSettings(message.guild.id, { prefix: '#', embedColor: '#000000' });
    const embedColor = settings.embedColor ? parseInt(settings.embedColor.replace('#',''), 16) : 0x000000;

    if (!message.member.permissions.has(PermissionsBitField.Flags.Administrator)) {
      const noPerms = new EmbedBuilder()
        .setColor(embedColor)
        .setDescription('âŒ You need **Administrator** permission to use this command.');
      return message.channel.send({ embeds: [noPerms] });
    }

    const action = args[0]; // enable / false
    const category = args[1]; // ban / kick / rolegive / roleremove / roleupdate / msgdelete / msgupdate / join / leave / channel / voice
    const channel = message.mentions.channels.first();

    if (!action || !category || !channel) {
      const usage = new EmbedBuilder()
        .setColor(embedColor)
        .setTitle('Command Usage')
        .setDescription(`\`${settings.prefix}logs [enable/false] [category] [#channel]\``)
        .setFooter({ text: message.author.username, iconURL: message.author.displayAvatarURL() });
      return message.channel.send({ embeds: [usage] });
    }

    const guildDir = path.join(__dirname, '..', 'data', 'guilds');
    if (!fs.existsSync(guildDir)) fs.mkdirSync(guildDir, { recursive: true });

    const filePath = path.join(guildDir, `${message.guild.id}.json`);
    let guildConfig = {};

    if (fs.existsSync(filePath)) {
      guildConfig = JSON.parse(fs.readFileSync(filePath, 'utf8'));
    }

    if (!guildConfig.logs) guildConfig.logs = {};

    if (action === 'false') {
      delete guildConfig.logs[category];
    } else if (action === 'enable') {
      guildConfig.logs[category] = channel.id;
    }

    fs.writeFileSync(filePath, JSON.stringify(guildConfig, null, 2));

    const done = new EmbedBuilder()
      .setColor(embedColor)
      .setDescription(`âœ… Logs for **${category}** ${action === 'false' ? 'disabled' : `enabled in ${channel}`}!`);
    await message.channel.send({ embeds: [done] });
  }
};



// events/logs.js
const fs = require('fs');
const path = require('path');
const { EmbedBuilder, AuditLogEvent } = require('discord.js');

function getGuildConfig(guildId) {
  const filePath = path.join(__dirname, '..', 'data', 'guilds', `${guildId}.json`);
  if (!fs.existsSync(filePath)) return null;
  return JSON.parse(fs.readFileSync(filePath, 'utf8'));
}

function sendLog(guild, category, embed) {
  const config = getGuildConfig(guild.id);
  if (!config || !config.logs || !config.logs[category]) return;
  const channel = guild.channels.cache.get(config.logs[category]);
  if (channel) channel.send({ embeds: [embed] }).catch(() => {});
}

module.exports = (client) => {
  // Ban
  client.on('guildBanAdd', async (ban) => {
    const fetchedLogs = await ban.guild.fetchAuditLogs({ type: AuditLogEvent.MemberBanAdd, limit: 1 });
    const log = fetchedLogs.entries.first();
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸš« Member Banned')
      .addFields(
        { name: 'Banned User', value: `${ban.user} (\`${ban.user.id}\`)` },
        { name: 'Banned By', value: log?.executor ? `${log.executor} (\`${log.executor.id}\`)` : 'Unknown' },
        { name: 'Reason', value: log?.reason || 'No reason provided' }
      )
      .setTimestamp();
    sendLog(ban.guild, 'ban', embed);
  });

  // Kick
  client.on('guildMemberRemove', async (member) => {
    const fetchedLogs = await member.guild.fetchAuditLogs({ type: AuditLogEvent.MemberKick, limit: 1 });
    const log = fetchedLogs.entries.first();
    if (!log) return;
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ‘¢ Member Kicked')
      .addFields(
        { name: 'Kicked User', value: `${member.user} (\`${member.user.id}\`)` },
        { name: 'Kicked By', value: log.executor ? `${log.executor} (\`${log.executor.id}\`)` : 'Unknown' },
        { name: 'Reason', value: log.reason || 'No reason provided' }
      )
      .setTimestamp();
    sendLog(member.guild, 'kick', embed);
  });

  // Role Add / Remove
  client.on('guildMemberUpdate', async (oldMember, newMember) => {
    const addedRoles = newMember.roles.cache.filter(r => !oldMember.roles.cache.has(r.id));
    const removedRoles = oldMember.roles.cache.filter(r => !newMember.roles.cache.has(r.id));

    if (addedRoles.size > 0) {
      const embed = new EmbedBuilder()
        .setColor(0x000000)
        .setTitle('â• Role Added')
        .setDescription(`${newMember} was given role(s): ${addedRoles.map(r => r.name).join(', ')}`)
        .setTimestamp();
      sendLog(newMember.guild, 'rolegive', embed);
    }

    if (removedRoles.size > 0) {
      const embed = new EmbedBuilder()
        .setColor(0x000000)
        .setTitle('â– Role Removed')
        .setDescription(`${newMember} lost role(s): ${removedRoles.map(r => r.name).join(', ')}`)
        .setTimestamp();
      sendLog(newMember.guild, 'roleremove', embed);
    }
  });

  // Role Update
  client.on('roleUpdate', async (oldRole, newRole) => {
    const changes = [];
    if (oldRole.name !== newRole.name) changes.push(`Name: \`${oldRole.name}\` â†’ \`${newRole.name}\``);
    if (oldRole.permissions.bitfield !== newRole.permissions.bitfield) changes.push('Permissions updated');
    if (changes.length === 0) return;
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ› ï¸ Role Updated')
      .setDescription(changes.join('\n'))
      .setTimestamp();
    sendLog(newRole.guild, 'roleupdate', embed);
  });

  // Message Delete
  client.on('messageDelete', (msg) => {
    if (!msg.guild || msg.author?.bot) return;
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ—‘ï¸ Message Deleted')
      .addFields(
        { name: 'Author', value: `${msg.author} (\`${msg.author.id}\`)` },
        { name: 'Channel', value: `${msg.channel}` },
        { name: 'Content', value: msg.content || 'No content' }
      )
      .setTimestamp();
    sendLog(msg.guild, 'msgdelete', embed);
  });

  // Message Update
  client.on('messageUpdate', (oldMsg, newMsg) => {
    if (!newMsg.guild || newMsg.author?.bot) return;
    if (oldMsg.content === newMsg.content) return;
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('âœï¸ Message Edited')
      .addFields(
        { name: 'Author', value: `${newMsg.author} (\`${newMsg.author.id}\`)` },
        { name: 'Channel', value: `${newMsg.channel}` },
        { name: 'Before', value: oldMsg.content || 'No content' },
        { name: 'After', value: newMsg.content || 'No content' }
      )
      .setTimestamp();
    sendLog(newMsg.guild, 'msgupdate', embed);
  });

  // Member Join
  client.on('guildMemberAdd', (member) => {
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ‘‹ Member Joined')
      .setDescription(`${member} (\`${member.id}\`)`)
      .setTimestamp();
    sendLog(member.guild, 'join', embed);
  });

  // Member Leave
  client.on('guildMemberRemove', (member) => {
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ‘‹ Member Left')
      .setDescription(`${member.user.tag} (\`${member.id}\`)`)
      .setTimestamp();
    sendLog(member.guild, 'leave', embed);
  });

  // Channel Create/Delete/Update
  client.on('channelCreate', (ch) => {
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ“‚ Channel Created')
      .setDescription(`${ch} (\`${ch.id}\`)`)
      .setTimestamp();
    sendLog(ch.guild, 'channel', embed);
  });

  client.on('channelDelete', (ch) => {
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ“‚ Channel Deleted')
      .setDescription(`${ch.name} (\`${ch.id}\`)`)
      .setTimestamp();
    sendLog(ch.guild, 'channel', embed);
  });

  client.on('channelUpdate', (oldCh, newCh) => {
    if (oldCh.name === newCh.name) return;
    const embed = new EmbedBuilder()
      .setColor(0x000000)
      .setTitle('ğŸ“‚ Channel Updated')
      .setDescription(`Name: \`${oldCh.name}\` â†’ \`${newCh.name}\``)
      .setTimestamp();
    sendLog(newCh.guild, 'channel', embed);
  });

  // Voice State Update
  client.on('voiceStateUpdate', (oldState, newState) => {
    if (oldState.channelId !== newState.channelId) {
      if (!oldState.channelId && newState.channelId) {
        const embed = new EmbedBuilder()
          .setColor(0x000000)
          .setTitle('ğŸ”Š Voice Join')
          .setDescription(`${newState.member} joined ${newState.channel}`)
          .setTimestamp();
        sendLog(newState.guild, 'voice', embed);
      } else if (oldState.channelId && !newState.channelId) {
        const embed = new EmbedBuilder()
          .setColor(0x000000)
          .setTitle('ğŸ”‡ Voice Leave')
          .setDescription(`${oldState.member} left ${oldState.channel}`)
          .setTimestamp();
        sendLog(oldState.guild, 'voice', embed);
      } else {
        const embed = new EmbedBuilder()
          .setColor(0x000000)
          .setTitle('ğŸ” Voice Move')
          .setDescription(`${newState.member} moved from ${oldState.channel} to ${newState.channel}`)
          .setTimestamp();
        sendLog(newState.guild, 'voice', embed);
      }
    }
  });
};