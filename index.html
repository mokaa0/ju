const { Client } = require('discord.js-selfbot-v13');
const fs = require('fs').promises;

const EXCLUDED_GUILD_ID = '1441856943265419266'; // السيرفر المستثنى

class DiscordSelfbotFetcher {
    constructor() {
        this.accounts = [];
    }

    async loadTokens() {
        try {
            const data = await fs.readFile('tokens.txt', 'utf8');
            return data.split('\n')
                .map(token => token.trim())
                .filter(token => token.length > 0);
        } catch (error) {
            console.error('Error reading tokens.txt:', error.message);
            return [];
        }
    }

    async fetchAccountInfo(token) {
        const client = new Client({
            checkUpdate: false
        });

        return new Promise((resolve, reject) => {
            client.once('ready', async () => {
                try {
                    console.log(`Logged in as: ${client.user.tag} (${client.user.id})`);
                    
                    const userInfo = {
                        username: client.user.username,
                        discriminator: client.user.discriminator,
                        id: client.user.id,
                        tokenPreview: token.substring(0, 25) + '...',
                        guilds: []
                    };

                    // الحصول على جميع السيرفرات
                    const guilds = client.guilds.cache;
                    
                    console.log(`Found ${guilds.size} guilds for ${client.user.tag}`);
                    
                    for (const [guildId, guild] of guilds) {
                        // تخطي السيرفر المستثنى
                        if (guildId === EXCLUDED_GUILD_ID) {
                            console.log(`Skipping excluded guild: ${guild.name} (${guildId})`);
                            continue;
                        }

                        // إضافة معلومات السيرفر
                        userInfo.guilds.push({
                            id: guildId,
                            name: guild.name || 'Unknown Guild',
                            memberCount: guild.memberCount || 'N/A',
                            joinedAt: guild.joinedAt || new Date()
                        });
                    }
                    
                    resolve(userInfo);
                } catch (error) {
                    reject(error);
                } finally {
                    client.destroy();
                }
            });

            client.on('error', (error) => {
                reject(error);
            });

            // تسجيل الدخول باستخدام التوكن
            client.login(token).catch(reject);
        });
    }

    async displayResults() {
        console.log('\n' + '='.repeat(80));
        console.log('DISCORD SELF-BOT ACCOUNTS INFORMATION');
        console.log('='.repeat(80) + '\n');
        
        let totalGuilds = 0;
        
        this.accounts.forEach((account, index) => {
            console.log(`${index + 1}. ${account.username}#${account.discriminator} (ID: ${account.id})`);
            console.log(`   Token Preview: ${account.tokenPreview}`);
            
            if (account.error) {
                console.log(`   Error: ${account.error}`);
            } else {
                console.log(`   Total Servers (excluding excluded one): ${account.guilds.length}`);
                
                if (account.guilds.length > 0) {
                    totalGuilds += account.guilds.length;
                    
                    // طباعة التنسيق المطلوب: user1 | اسم السيرفر
                    console.log('\n   Requested Format (username | server_name):');
                    account.guilds.forEach(guild => {
                        console.log(`   ${account.username} | ${guild.name}`);
                    });
                    
                    // طباعة معلومات مفصلة عن السيرفرات
                    console.log('\n   Detailed Server Information:');
                    account.guilds.forEach(guild => {
                        const joinDate = guild.joinedAt ? guild.joinedAt.toLocaleDateString() : 'Unknown';
                        console.log(`   - ${guild.name} (ID: ${guild.id})`);
                        console.log(`     Members: ${guild.memberCount} | Joined: ${joinDate}`);
                    });
                } else {
                    console.log('\n   No servers found (or only in excluded server)');
                }
            }
            
            console.log('\n' + '-'.repeat(80) + '\n');
        });
        
        console.log(`Total accounts processed: ${this.accounts.length}`);
        console.log(`Total servers found (excluding server ${EXCLUDED_GUILD_ID}): ${totalGuilds}`);
        
        // طباعة التنسيق النهائي فقط
        console.log('\n' + '='.repeat(80));
        console.log('FINAL OUTPUT (username | server_name):');
        console.log('='.repeat(80));
        
        this.accounts.forEach(account => {
            if (!account.error && account.guilds.length > 0) {
                account.guilds.forEach(guild => {
                    console.log(`${account.username} | ${guild.name}`);
                });
            }
        });
    }

    async fetchAllAccounts() {
        const tokens = await this.loadTokens();
        
        if (tokens.length === 0) {
            console.log('No tokens found in tokens.txt');
            return;
        }
        
        console.log(`Found ${tokens.length} token(s) to process\n`);
        
        for (let i = 0; i < tokens.length; i++) {
            const token = tokens[i];
            console.log(`\n[${i + 1}/${tokens.length}] Processing token...`);
            
            try {
                const accountInfo = await this.fetchAccountInfo(token);
                this.accounts.push(accountInfo);
                console.log(`Successfully fetched info for: ${accountInfo.username}#${accountInfo.discriminator}`);
                console.log(`Found ${accountInfo.guilds.length} servers (excluding server ${EXCLUDED_GUILD_ID})`);
            } catch (error) {
                console.log(`Failed to process token ${i + 1}: ${error.message}`);
                // إضافة معلومات التوكن الفاشل
                this.accounts.push({
                    username: 'INVALID_TOKEN',
                    discriminator: '0000',
                    id: 'N/A',
                    tokenPreview: token.substring(0, 25) + '...',
                    guilds: [],
                    error: error.message
                });
            }
            
            // تأخير لتجنب Rate Limit
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        // عرض النتائج
        await this.displayResults();
    }
}

// التنفيذ الرئيسي
async function main() {
    const fetcher = new DiscordSelfbotFetcher();
    
    try {
        await fetcher.fetchAllAccounts();
    } catch (error) {
        console.error('Fatal error:', error);
    }
}

// تشغيل السكربت
if (require.main === module) {
    main();
}

module.exports = DiscordSelfbotFetcher;