const express = require("express");
const session = require("express-session");
const passport = require("passport");
const DiscordStrategy = require("passport-discord").Strategy;
const fetch = require("node-fetch");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 3000;

// ===== إعدادات البوت والموقع =====
const CLIENT_ID = "ضع_CLIENT_ID_هنا";
const CLIENT_SECRET = "ضع_CLIENT_SECRET_هنا";
const CALLBACK_URL = "https://اسم_الموقع_حقك.up.railway.app/auth/discord/callback";
const BOT_API_URL = "http://IP_البوت_العام:PORT"; // مثال: http://123.45.67.89:3000

// ===== إعدادات الجلسة =====
app.use(session({
    secret: "secret_key",
    resave: false,
    saveUninitialized: false
}));

app.use(passport.initialize());
app.use(passport.session());
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

// ===== إعداد الباسبور للـ Discord OAuth2 =====
passport.serializeUser((user, done) => done(null, user));
passport.deserializeUser((obj, done) => done(null, obj));

passport.use(new DiscordStrategy({
    clientID: CLIENT_ID,
    clientSecret: CLIENT_SECRET,
    callbackURL: CALLBACK_URL,
    scope: ['identify', 'email', 'guilds']
}, (accessToken, refreshToken, profile, done) => {
    return done(null, profile);
}));

// ===== تسجيل الدخول =====
app.get("/auth/discord", passport.authenticate("discord"));
app.get("/auth/discord/callback",
    passport.authenticate("discord", { failureRedirect: "/" }),
    (req, res) => res.redirect("/dashboard")
);

// ===== التحقق من تسجيل الدخول =====
function checkAuth(req, res, next) {
    if (req.isAuthenticated()) return next();
    res.redirect("/");
}

// ===== تسجيل الخروج =====
app.get("/logout", (req, res) => {
    req.logout(() => {});
    res.redirect("/");
});

// ===== API لجلب بيانات المستخدم =====
app.get("/api/user", checkAuth, (req, res) => {
    const guilds = req.user.guilds.filter(g => (g.permissions & 0x8) === 0x8);
    res.json({ user: req.user, guilds });
});

// ===== API لجلب البريفكس =====
app.get("/api/prefix", checkAuth, async (req, res) => {
    try {
        const data = await fetch(`${BOT_API_URL}/prefix`).then(r => r.json());
        res.json(data);
    } catch (err) {
        res.status(500).send("تعذر جلب البريفكس");
    }
});

// ===== API لتغيير البريفكس =====
app.post("/api/prefix", checkAuth, async (req, res) => {
    try {
        const body = req.body;
        await fetch(`${BOT_API_URL}/prefix`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prefix: body.prefix })
        });
        res.send("تم تغيير البريفكس");
    } catch (err) {
        res.status(500).send("تعذر تغيير البريفكس");
    }
});

// ===== صفحات HTML =====
app.get("/", (req, res) => res.sendFile(path.join(__dirname, "public", "index.html")));
app.get("/dashboard", checkAuth, (req, res) => res.sendFile(path.join(__dirname, "public", "dashboard.html")));

app.listen(PORT, () => console.log(`الموقع يعمل على البورت ${PORT}`));