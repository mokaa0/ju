const fs = require('fs');
const figlet = require('figlet');
const chalk = require('chalk');
const axios = require('axios');

function clearConsole() {
  process.stdout.write('\x1Bc');
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function main() {
  clearConsole();

  // العنوان
  console.log(
    chalk.cyanBright(figlet.textSync('Qya', { horizontalLayout: 'default' }))
  );

  console.log(chalk.blue('•'));
  console.log(chalk.white('Qya Studio - name tokens tool'));
  console.log(chalk.yellow('Developed by .884.'));
  console.log(chalk.yellow('Random name'));
  console.log(chalk.green('Loading Tool…'));

  // تحميل الأسماء
  let names = fs.readFileSync('name.txt', 'utf-8')
    .split('\n')
    .map(name => name.trim())
    .filter(Boolean);

  console.log(chalk.green(`Loaded ${names.length} names`));

  // تحميل التوكنات
  let tokens = fs.readFileSync('tokens.txt', 'utf-8')
    .split('\n')
    .map(t => t.trim())
    .filter(Boolean);

  console.log(chalk.green(`Loaded ${tokens.length} tokens`));
  console.log(chalk.yellow('Connecting valid accounts…'));

  let valid = 0;
  let invalid = 0;

  for (let token of tokens) {
    // تحقق من أن لدينا أسماء متبقية
    if (names.length === 0) {
      console.log(chalk.red('No more names available in name.txt!'));
      break;
    }

    // تحقق أولي من التوكن
    try {
      const check = await axios.get('https://discord.com/api/v10/users/@me', {
        headers: {
          Authorization: token
        }
      });

      if (check.data.bot) {
        console.log(chalk.red(`${token.slice(0, 15)}... - Bot token, skipping.`));
        invalid++;
        continue;
      }
    } catch (err) {
      const part = token.slice(0, 15) + '...';
      const message = err.response?.data?.message || 'Unknown error';
      console.log(chalk.red(`${part} - Invalid token (${message})`));
      invalid++;
      continue;
    }

    // اسم عشوائي
    const randomIndex = Math.floor(Math.random() * names.length);
    const randomName = names[randomIndex];
    names.splice(randomIndex, 1); // حذف الاسم
    fs.writeFileSync('name.txt', names.join('\n')); // تحديث ملف الأسماء

    // محاولة تغيير الاسم
    try {
      await axios.patch(
        'https://discord.com/api/v10/users/@me',
        { username: randomName },
        {
          headers: {
            Authorization: token,
            'Content-Type': 'application/json',
          },
        }
      );

      const tokenPart = token.slice(0, 15) + '...';
      console.log(chalk.blue(`${tokenPart} - ${randomName}`));
      valid++;
    } catch (err) {
      const tokenPart = token.slice(0, 15) + '...';
      const message = err.response?.data?.message || 'Unknown error';
      console.log(chalk.red(`${tokenPart} - Failed to set name (${message})`));
      invalid++;
    }

    await sleep(1000); // انتظار بين الطلبات
  }

  console.log(chalk.green('All accounts initialized.'));
  console.log(chalk.green(`Status`));
  console.log(chalk.green(` - Valid tokens total : ${valid}`));
  console.log(chalk.green(` - Invalid tokens : ${invalid}`));
}

main();