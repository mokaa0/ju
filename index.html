from flask import Flask, request, jsonify
import requests
import threading
import random
import time
import websocket
import json

app = Flask(__name__)
VALID_TOKENS = []
INVALID_TOKENS = []

def start_discord_session(token, status_type):
    ws = websocket.WebSocket()
    try:
        ws.connect("wss://gateway.discord.gg/?v=9&encoding=json")

        # Identify payload
        payload = {
            "op": 2,
            "d": {
                "token": token,
                "properties": {
                    "$os": "windows",
                    "$browser": "chrome",
                    "$device": "pc"
                },
                "presence": {
                    "status": status_type,
                    "activities": [],
                    "afk": False
                }
            }
        }

        ws.send(json.dumps(payload))
        # تخليه شغال 24/7
        while True:
            time.sleep(60)
    except Exception as e:
        print(f"[!] Failed token: {token[:10]}...")

@app.route("/upload_tokens", methods=["POST"])
def upload_tokens():
    data = request.json
    tokens = data.get("tokens", [])

    VALID_TOKENS.clear()
    INVALID_TOKENS.clear()

    for token in tokens:
        headers = {"Authorization": token}
        res = requests.get("https://discord.com/api/v9/users/@me", headers=headers)

        if res.status_code == 200:
            user = res.json()
            username = f"{user['username']}#{user['discriminator']}"
            status_type = random.choice(["online", "idle", "dnd"])
            VALID_TOKENS.append({"token": token, "username": username, "status": status_type})

            # Start WebSocket session
            threading.Thread(target=start_discord_session, args=(token, status_type)).start()
        else:
            INVALID_TOKENS.append(token)

    return jsonify({
        "status": "done",
        "valid_count": len(VALID_TOKENS),
        "invalid_count": len(INVALID_TOKENS),
        "valid_users": VALID_TOKENS
    })

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=7869)