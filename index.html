import discord
import asyncio
import random
import logging

# Settings
TOKENS_FILE = "tokens.txt"
STATUSES = ["dnd", "idle", "online"]
ACTIVITIES = ["Watching", "Playing", "Listening"]

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class DiscordAccount:
    def __init__(self, token, account_number):
        self.token = token
        self.account_number = account_number
        
        # User account mode
        intents = discord.Intents.default()
        intents.message_content = True
        intents.guilds = True
        intents.reactions = True
        
        self.client = discord.Client(intents=intents)
        self.setup_handlers()
    
    def setup_handlers(self):
        @self.client.event
        async def on_ready():
            logger.info(f"Account {self.account_number} ready: {self.client.user.name}")
            
            # Set random status
            await self.set_random_status()
            
            # Update status periodically
            asyncio.create_task(self.status_update_loop())
        
        @self.client.event
        async def on_message(message):
            # Ignore our own messages
            if message.author.id == self.client.user.id:
                return
            
            # Only respond in guilds
            if not message.guild:
                return
            
            # Check if author is a member
            if not isinstance(message.author, discord.Member):
                return
            
            # Check for Manage Guild permission
            if not message.author.guild_permissions.manage_guild:
                return
            
            # Trigger words
            trigger_words = ["بدون شروط", "شارك بس", "@here", "@everyone"]
            message_content = message.content
            
            # Check if any trigger word exists
            found_trigger = any(word in message_content for word in trigger_words)
            
            if found_trigger:
                logger.info(f"Account {self.account_number}: Trigger detected from {message.author.name}")
                
                # If message is a reply to another message
                if message.reference and message.reference.message_id:
                    try:
                        channel = message.channel
                        target_message = await channel.fetch_message(message.reference.message_id)
                        
                        # Get all reactions on the target message
                        if target_message.reactions:
                            # Click on the first reaction available
                            first_reaction = target_message.reactions[0]
                            
                            # Add our reaction
                            await first_reaction.add()
                            logger.info(f"Account {self.account_number}: Reacted to message in {message.guild.name}")
                        
                    except Exception as e:
                        logger.error(f"Account {self.account_number}: Error: {e}")
    
    async def set_random_status(self):
        try:
            status_type = random.choice(STATUSES)
            activity_text = random.choice(ACTIVITIES)
            
            if status_type == "dnd":
                await self.client.change_presence(
                    status=discord.Status.dnd,
                    activity=discord.Game(name=activity_text)
                )
            elif status_type == "idle":
                await self.client.change_presence(
                    status=discord.Status.idle,
                    activity=discord.Game(name=activity_text)
                )
            else:
                await self.client.change_presence(
                    status=discord.Status.online,
                    activity=discord.Game(name=activity_text)
                )
            
            logger.info(f"Account {self.account_number}: Status set to {status_type}")
        except Exception as e:
            logger.error(f"Account {self.account_number}: Status error: {e}")
    
    async def status_update_loop(self):
        while True:
            wait_time = random.randint(600, 1800)  # 10-30 minutes
            await asyncio.sleep(wait_time)
            await self.set_random_status()
    
    async def start(self):
        try:
            await self.client.start(self.token, bot=False)
        except discord.LoginFailure:
            logger.error(f"Account {self.account_number}: Invalid token")
        except Exception as e:
            logger.error(f"Account {self.account_number}: Error: {e}")

class MultiAccountManager:
    def __init__(self):
        self.accounts = []
    
    def load_tokens(self):
        try:
            with open(TOKENS_FILE, 'r', encoding='utf-8') as f:
                tokens = [line.strip() for line in f if line.strip()]
            
            for i, token in enumerate(tokens, 1):
                account = DiscordAccount(token, i)
                self.accounts.append(account)
            
            logger.info(f"Loaded {len(tokens)} accounts")
        except FileNotFoundError:
            logger.error(f"File {TOKENS_FILE} not found")
    
    async def start_all_accounts(self):
        self.load_tokens()
        
        if not self.accounts:
            logger.error("No accounts to start")
            return
        
        tasks = []
        for account in self.accounts:
            task = asyncio.create_task(account.start())
            tasks.append(task)
        
        try:
            await asyncio.gather(*tasks)
        except KeyboardInterrupt:
            logger.info("Shutting down...")
        except Exception as e:
            logger.error(f"Manager error: {e}")

async def main():
    manager = MultiAccountManager()
    await manager.start_all_accounts()

if __name__ == "__main__":
    asyncio.run(main())