const readline = require('readline');
const chalk = require('chalk');
const figlet = require('figlet');
const axios = require('axios');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

// Increased delay to avoid detection
const DELAY = 10000;

// === Main Menu ===
function showMainMenu() {
    console.clear();
    console.log(chalk.red(figlet.textSync('Original', { font: '3D-ASCII' })));
    console.log(chalk.red('='.repeat(50)));
    console.log(chalk.red.bold('\n[1] HypeSquad For Tokens'));
    console.log(chalk.red.bold('[2] About Me For Tokens'));
    console.log(chalk.red.bold('[3] Add Tokens To Server'));
    console.log(chalk.red.bold('[4] Token Check'));
    console.log(chalk.red('='.repeat(50)));
    
    rl.question(chalk.yellow('\nSelect option (1-4): '), handleChoice);
}

// === Handle Choice ===
async function handleChoice(choice) {
    console.clear();
    switch(choice) {
        case '1': await getHypeSquad(); break;
        case '2': await setAboutMe(); break;
        case '3': await joinServer(); break;
        case '4': await checkTokens(); break;
        default: 
            console.log(chalk.red('Invalid choice'));
            setTimeout(showMainMenu, 2000);
    }
}

// === Option 1: Get HypeSquad Badge ===
async function getHypeSquad() {
    console.log(chalk.cyan('Add Tokens - Paste all tokens (one per line):\n'));
    console.log(chalk.gray('Example:'));
    console.log(chalk.gray('MTxxxxx.xxxx.xxxx'));
    console.log(chalk.gray('MTyyyyy.yyyy.yyyy'));
    console.log(chalk.gray('MTzzzzz.zzzz.zzzz'));
    console.log(chalk.gray('\nPaste your tokens below:'));
    
    const tokens = await getAllTokens();
    if (!tokens || tokens.length === 0) {
        console.log(chalk.red('No tokens provided!'));
        return setTimeout(showMainMenu, 2000);
    }
    
    console.log(chalk.gray(`\nFound ${tokens.length} tokens. Starting...`));
    
    let success = 0, failed = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`\n[${i+1}/${tokens.length}] Processing token...`));
            
            const userResponse = await axios.get('https://discord.com/api/v9/users/@me', {
                headers: { 
                    Authorization: tokens[i],
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            const userTag = `${userResponse.data.username}#${userResponse.data.discriminator}`;
            const flags = userResponse.data.public_flags || 0;
            
            const hasBravery = (flags & 64) !== 0;
            const hasBrilliance = (flags & 128) !== 0;
            const hasBalance = (flags & 256) !== 0;
            
            if (!hasBravery && !hasBrilliance && !hasBalance) {
                const houseId = Math.floor(Math.random() * 3) + 1;
                const response = await axios.post('https://discord.com/api/v9/hypesquad/online', 
                    { house_id: houseId },
                    { 
                        headers: { 
                            Authorization: tokens[i],
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    }
                );
                
                if (response.status === 204) {
                    console.log(chalk.green(`✓ ${userTag} - HypeSquad added`));
                    success++;
                } else {
                    console.log(chalk.red(`✗ ${userTag} - Failed`));
                    failed++;
                }
            } else {
                console.log(chalk.yellow(`⚠ ${userTag} - Already has HypeSquad`));
                success++;
            }
        } catch (error) {
            if (error.response?.status === 401) {
                console.log(chalk.red(`✗ Invalid token`));
            } else {
                console.log(chalk.red(`✗ Error: ${error.response?.data?.message || error.message}`));
            }
            failed++;
        }
        
        if (i < tokens.length - 1) {
            console.log(chalk.gray(`Waiting ${DELAY/1000} seconds...`));
            await delay(DELAY);
        }
    }
    
    showResults(success, failed);
}

// === Option 2: Set About Me ===
async function setAboutMe() {
    console.log(chalk.cyan('Add Tokens - Paste all tokens (one per line):\n'));
    console.log(chalk.gray('Example:'));
    console.log(chalk.gray('MTxxxxx.xxxx.xxxx'));
    console.log(chalk.gray('MTyyyyy.yyyy.yyyy'));
    console.log(chalk.gray('\nPaste your tokens below:'));
    
    const tokens = await getAllTokens();
    if (!tokens || tokens.length === 0) {
        console.log(chalk.red('No tokens provided!'));
        return setTimeout(showMainMenu, 2000);
    }
    
    console.log(chalk.gray(`\nFound ${tokens.length} tokens. Starting...`));
    
    const aboutTexts = [
        "Professional gamer and streamer",
        "Software developer exploring new technologies",
        "Book lover and world traveler",
        "Digital artist and creative mind",
        "Science enthusiast and researcher",
        "Full stack developer and tech blogger",
        "University student and part-time freelancer",
        "Photographer and adventure seeker"
    ];
    
    let success = 0, failed = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`\n[${i+1}/${tokens.length}] Processing...`));
            
            const bio = aboutTexts[Math.floor(Math.random() * aboutTexts.length)];
            const response = await axios.patch('https://discord.com/api/v9/users/@me',
                { bio: bio },
                { 
                    headers: { 
                        Authorization: tokens[i],
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                }
            );
            
            console.log(chalk.green(`✓ ${response.data.username}#${response.data.discriminator} - About Me updated`));
            success++;
        } catch (error) {
            if (error.response?.status === 401) {
                console.log(chalk.red(`✗ Invalid token`));
            } else if (error.response?.status === 403) {
                console.log(chalk.red(`✗ Account has restrictions`));
            } else {
                console.log(chalk.red(`✗ Error: ${error.response?.data?.message || error.message}`));
            }
            failed++;
        }
        
        if (i < tokens.length - 1) {
            console.log(chalk.gray(`Waiting ${DELAY/1000} seconds...`));
            await delay(DELAY);
        }
    }
    
    showResults(success, failed);
}

// === Option 3: Join Server ===
async function joinServer() {
    console.log(chalk.cyan('Add Tokens - Paste all tokens (one per line):\n'));
    console.log(chalk.gray('Example:'));
    console.log(chalk.gray('MTxxxxx.xxxx.xxxx'));
    console.log(chalk.gray('MTyyyyy.yyyy.yyyy'));
    console.log(chalk.gray('\nPaste your tokens below:'));
    
    const tokens = await getAllTokens();
    if (!tokens || tokens.length === 0) {
        console.log(chalk.red('No tokens provided!'));
        return setTimeout(showMainMenu, 2000);
    }
    
    console.log(chalk.gray(`\nFound ${tokens.length} tokens. Now enter server link:`));
    
    rl.question(chalk.yellow('Enter server invite link (discord.gg/XXXX): '), async (inviteLink) => {
        const inviteCode = extractInviteCode(inviteLink);
        if (!inviteCode) {
            console.log(chalk.red('Invalid invite link!'));
            return setTimeout(showMainMenu, 2000);
        }
        
        console.log(chalk.gray(`\nStarting to join server with ${tokens.length} tokens...`));
        
        let success = 0, failed = 0;
        
        for (let i = 0; i < tokens.length; i++) {
            try {
                console.log(chalk.gray(`\n[${i+1}/${tokens.length}] Joining server...`));
                
                const response = await axios.post(`https://discord.com/api/v9/invites/${inviteCode}`,
                    {},
                    { 
                        headers: { 
                            Authorization: tokens[i],
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    }
                );
                
                console.log(chalk.green(`✓ Successfully joined server`));
                success++;
            } catch (error) {
                if (error.response?.status === 401) {
                    console.log(chalk.red(`✗ Invalid token`));
                } else if (error.response?.status === 403) {
                    console.log(chalk.red(`✗ Cannot join server`));
                } else if (error.response?.status === 429) {
                    console.log(chalk.red(`✗ Rate limited, waiting longer...`));
                    await delay(DELAY * 3);
                    i--; // Try same token again
                    continue;
                } else {
                    console.log(chalk.red(`✗ Error: ${error.response?.data?.message || error.message}`));
                }
                failed++;
            }
            
            if (i < tokens.length - 1) {
                console.log(chalk.gray(`Waiting ${DELAY/1000} seconds...`));
                await delay(DELAY);
            }
        }
        
        showResults(success, failed);
    });
}

// === Option 4: Check Tokens ===
async function checkTokens() {
    console.log(chalk.cyan('Add Tokens - Paste all tokens (one per line):\n'));
    console.log(chalk.gray('Example:'));
    console.log(chalk.gray('MTxxxxx.xxxx.xxxx'));
    console.log(chalk.gray('MTyyyyy.yyyy.yyyy'));
    console.log(chalk.gray('MTzzzzz.zzzz.zzzz'));
    console.log(chalk.gray('\nPaste your tokens below:'));
    
    const tokens = await getAllTokens();
    if (!tokens || tokens.length === 0) {
        console.log(chalk.red('No tokens provided!'));
        return setTimeout(showMainMenu, 2000);
    }
    
    console.log(chalk.gray(`\nFound ${tokens.length} tokens. Checking...`));
    
    let valid = 0, invalid = 0;
    
    for (let i = 0; i < tokens.length; i++) {
        try {
            console.log(chalk.gray(`\n[${i+1}/${tokens.length}] Checking...`));
            
            const response = await axios.get('https://discord.com/api/v9/users/@me', {
                headers: { 
                    Authorization: tokens[i],
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            const userTag = `${response.data.username}#${response.data.discriminator}`;
            const verified = response.data.verified ? '✓ Verified' : '✗ Not verified';
            
            console.log(chalk.green(`✓ ${userTag} - Valid (${verified})`));
            valid++;
        } catch (error) {
            console.log(chalk.red(`✗ Invalid/expired token`));
            invalid++;
        }
        
        if (i < tokens.length - 1) {
            await delay(2000);
        }
    }
    
    console.log(chalk.cyan('\n' + '='.repeat(40)));
    console.log(chalk.white.bold('TOKEN CHECK RESULTS:'));
    console.log(chalk.green(`Valid tokens: ${valid}`));
    console.log(chalk.red(`Invalid tokens: ${invalid}`));
    console.log(chalk.cyan('='.repeat(40)));
    
    console.log(chalk.gray('\nPress Enter to continue...'));
    rl.question('', () => {
        showMainMenu();
    });
}

// === NEW FUNCTION: Get all tokens at once ===
async function getAllTokens() {
    return new Promise((resolve) => {
        console.log(chalk.gray('(Paste all tokens, then press Enter twice to finish)'));
        console.log(chalk.gray('-' .repeat(40)));
        
        const lines = [];
        
        rl.on('line', (line) => {
            if (line.trim() === '' && lines.length > 0) {
                // Empty line after tokens means finished
                rl.removeAllListeners('line');
                const tokens = lines
                    .filter(l => l.trim() !== '')
                    .map(l => l.trim())
                    .filter(token => token.length > 10); // Basic validation
                
                console.log(chalk.gray(`\nCollected ${tokens.length} tokens`));
                resolve(tokens);
            } else if (line.trim() !== '') {
                lines.push(line.trim());
            }
        });
        
        // Timeout after 30 seconds
        setTimeout(() => {
            if (lines.length > 0) {
                rl.removeAllListeners('line');
                const tokens = lines
                    .filter(l => l.trim() !== '')
                    .map(l => l.trim())
                    .filter(token => token.length > 10);
                
                console.log(chalk.gray(`\nCollected ${tokens.length} tokens (timeout)`));
                resolve(tokens);
            } else {
                resolve([]);
            }
        }, 30000);
    });
}

function extractInviteCode(link) {
    const patterns = [
        /discord\.gg\/([a-zA-Z0-9\-_]+)/,
        /discordapp\.com\/invite\/([a-zA-Z0-9\-_]+)/,
        /discord\.com\/invite\/([a-zA-Z0-9\-_]+)/
    ];
    
    for (const pattern of patterns) {
        const match = link.match(pattern);
        if (match && match[1]) {
            return match[1];
        }
    }
    
    return link.trim();
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function showResults(success, failed) {
    console.log(chalk.cyan('\n' + '='.repeat(40)));
    console.log(chalk.white.bold('OPERATION COMPLETED:'));
    console.log(chalk.green(`Success: ${success}`));
    console.log(chalk.red(`Failed: ${failed}`));
    console.log(chalk.yellow(`Total: ${success + failed}`));
    console.log(chalk.cyan('='.repeat(40)));
    
    setTimeout(() => {
        console.log(chalk.gray('\nReturning to main menu in 3 seconds...'));
        setTimeout(showMainMenu, 3000);
    }, 1000);
}

// === Start Program ===
console.log(chalk.red.bold('\n' + '='.repeat(50)));
console.log(chalk.red.bold('WARNING: This tool violates Discord ToS'));
console.log(chalk.red.bold('Accounts may be permanently banned'));
console.log(chalk.red.bold('='.repeat(50) + '\n'));

setTimeout(() => {
    showMainMenu();
}, 2000);