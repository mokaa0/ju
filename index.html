const figlet = require('figlet');
const chalk = require('chalk');
const fs = require('fs');
const fetch = require('node-fetch');

process.stdout.write('\x1Bc');
console.log(chalk.cyan(figlet.textSync('Qya', { horizontalLayout: 'default' })));
console.log(chalk.blue('\nQya Studio - username tokens tool'));
console.log(chalk.yellow('Developed by .884.'));
console.log(chalk.yellow('Random username'));
console.log(chalk.green('Loading Tool…'));

const usernamesPath = './username.txt';
const tokensPath = './tokens.txt';

let usernames = [];
let accounts = [];

try {
  usernames = fs.readFileSync(usernamesPath, 'utf-8').split('\n').filter(Boolean);
  console.log(chalk.green(`Loaded ${usernames.length} username`));
} catch (err) {
  console.log(chalk.red('Error loading usernames'));
  process.exit();
}

try {
  const rawLines = fs.readFileSync(tokensPath, 'utf-8').split('\n').filter(Boolean);
  accounts = rawLines.map(line => {
    const [token, password] = line.split('|').map(v => v.trim());
    return { token, password };
  });
  console.log(chalk.green(`Loaded ${accounts.length} tokens`));
} catch (err) {
  console.log(chalk.red('Error loading tokens'));
  process.exit();
}

console.log(chalk.yellow('Connecting valid accounts…'));

let valid = 0;
let invalid = 0;

async function changeUsername(token, password, newUsername) {
  try {
    const userInfo = await fetch('https://discord.com/api/v9/users/@me', {
      headers: { Authorization: token }
    });

    if (userInfo.status !== 200) return false;

    const data = await userInfo.json();

    const res = await fetch('https://discord.com/api/v9/users/@me', {
      method: 'PATCH',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: newUsername,
        password: password,
        discriminator: data.discriminator
      })
    });

    if (res.status === 200) {
      console.log(chalk.blue(`${token.slice(0, 15)}... - ${newUsername}`));
      return true;
    } else {
      return false;
    }
  } catch {
    return false;
  }
}

(async () => {
  for (const { token, password } of accounts) {
    if (usernames.length === 0) {
      console.log(chalk.red('No more usernames available'));
      break;
    }

    const username = usernames.shift();
    const success = await changeUsername(token, password, username);

    if (success) {
      valid++;
      fs.writeFileSync(usernamesPath, usernames.join('\n'));
    } else {
      invalid++;
    }

    await new Promise(r => setTimeout(r, 4000));
  }

  console.log(chalk.green('\nAll accounts initialized.\n'));
  console.log(chalk.green('Status'));
  console.log(chalk.green(` - Valid tokens total : ${valid}`));
  console.log(chalk.green(` - Invalid tokens : ${invalid}`));
})();